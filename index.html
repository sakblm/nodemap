<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>testApp - 興味マッピングアプリ</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'normal': ['Inter', '-apple-system', 'BlinkMacSystemFont', 'sans-serif'],
                        'handwriting': ['Zen Kurenaido', 'cursive'],
                        'klee': ['Klee One', 'cursive'],
                        'yusei': ['Yusei Magic', 'cursive'],
                        'hachi': ['Hachi Maru Pop', 'cursive'],
                    }
                }
            }
        }
    </script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Kurenaido&family=Klee+One:wght@400;600&family=Yusei+Magic&family=Hachi+Maru+Pop&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    <canvas id="particle-canvas" class="particle-canvas"></canvas>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // データを外部ファイルから読み込み
        let inlineData = {
            articles: [],
            hierarchical_tags: {}
        };

        // データ読み込み関数
        const loadData = async () => {
            try {
                console.log('🔄 データファイル読み込み開始...');
                
                const [articlesResponse, tagsResponse] = await Promise.all([
                    fetch('./data/articles.json'),
                    fetch('./data/hierarchical_tags.json')
                ]);
                
                if (!articlesResponse.ok) {
                    throw new Error(`Articles fetch failed: ${articlesResponse.status}`);
                }
                if (!tagsResponse.ok) {
                    throw new Error(`Tags fetch failed: ${tagsResponse.status}`);
                }
                
                const articles = await articlesResponse.json();
                const hierarchical_tags = await tagsResponse.json();
                
                inlineData = { articles, hierarchical_tags };
                console.log('✅ 外部データファイルから読み込み完了');
                console.log(`📰 記事数: ${articles.length}`);
                console.log(`🏷️ タグ数: ${Object.keys(hierarchical_tags).length}`);
                return true;
            } catch (error) {
                console.error('❌ データファイル読み込みエラー:', error);
                console.warn('🔄 フォールバックデータを使用');
                
                // 完全なフォールバックデータ（元のinlineDataと同じ）
                inlineData = {
                    articles: [
                        {
                            "title": "AIが生成する新しい音楽の可能性",
                            "tags": ["AI", "音楽", "技術"],
                            "source": "Tech Journal",
                            "snippet": "人工知能の進化により、作曲や演奏の分野で新たな可能性が広がっています。"
                        },
                        {
                            "title": "電気自動車、バッテリー技術の次世代トレンド",
                            "tags": ["電気自動車", "技術", "エネルギー", "SDGs"],
                            "source": "Future Daily",
                            "snippet": "全固体電池や新しい充電技術など、電気自動車の航続距離とコストを改善するイノベーションが注目を集めています。"
                        },
                        {
                            "title": "宇宙旅行、一般人向けツアーの最新動向",
                            "tags": ["宇宙", "旅行", "ロケット"],
                            "source": "Space Today",
                            "snippet": "宇宙への旅行が、一部の富裕層だけでなく、一般の人々にも手の届く時代になりつつあります。"
                        },
                        {
                            "title": "メタバースとVRが変えるビジネスの未来",
                            "tags": ["メタバース", "VR", "ビジネス"],
                            "source": "Business Insights",
                            "snippet": "仮想空間での会議や商品展示、イベント開催など、メタバースがもたらす新しいビジネスモデルが次々と登場しています。"
                        },
                        {
                            "title": "サスティナブルファッション：循環型社会への挑戦",
                            "tags": ["SDGs", "ファッション", "サスティナブル"],
                            "source": "Eco Life",
                            "snippet": "環境に配慮した素材選びや製造プロセス、古着のリサイクルなど、ファッション業界でもサスティナビリティへの取り組みが加速しています。"
                        },
                        {
                            "title": "犬種図鑑：柴犬の魅力",
                            "tags": ["動物", "犬", "ペット"],
                            "source": "Animal World",
                            "snippet": "日本の代表的な犬種である柴犬。その歴史や性格、飼育のポイントを解説します。"
                        }
                    ],
                    hierarchical_tags: {
                        "AI": ["機械学習", "自然言語処理", "画像認識"],
                        "技術": ["半導体", "量子コンピューター", "クラウド"],
                        "SDGs": ["循環型経済", "再生可能エネルギー", "サスティナブル"],
                        "音楽": ["DTM", "楽器", "ライブ"],
                        "電気自動車": ["バッテリー", "充電技術"],
                        "宇宙": ["ISS", "スペースシャトル", "天体観測"],
                        "旅行": ["秘境", "ツアー", "世界遺産", "国内旅行"],
                        "ビジネス": ["スタートアップ", "マーケティング", "経営戦略"],
                        "ファッション": ["アパレル", "デザイン", "ZOZO"],
                        "動物": ["犬", "猫", "魚"],
                        "犬": ["犬種", "飼育"],
                        "ペット": ["飼育", "用品", "病気"]
                    }
                };
                return false;
            }
        };

        // パーティクルシステム
        function ParticleSystem() {
            const canvasRef = useRef();
            const particles = useRef([]);
            const animationFrame = useRef();

            const startParticleEffect = (startX, startY, tags) => {
                const canvas = canvasRef.current;
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                particles.current = [];

                // ドットパーティクルの生成
                for (let i = 0; i < 30; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = 2 + Math.random() * 4;
                    particles.current.push({
                        x: startX,
                        y: startY,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed - 2,
                        size: 2 + Math.random() * 3,
                        color: `hsl(${Math.random() * 360}, 70%, 65%)`,
                        opacity: 1,
                        type: 'dot'
                    });
                }

                // タグテキストパーティクルの生成
                tags.forEach((tag, index) => {
                    const angle = (index / tags.length) * Math.PI * 2;
                    const speed = 1.5 + Math.random() * 2;
                    particles.current.push({
                        x: startX,
                        y: startY,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed - 1,
                        size: 14,
                        color: '#ffffff',
                        opacity: 1,
                        type: 'text',
                        text: tag
                    });
                });

                animateParticles(ctx);
            };

            const animateParticles = (ctx) => {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

                particles.current = particles.current.filter(particle => {
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    particle.vy += 0.03;
                    particle.opacity -= 0.008;
                    particle.vx *= 0.99;

                    if (particle.type === 'dot') {
                        ctx.save();
                        ctx.globalAlpha = particle.opacity;
                        ctx.fillStyle = particle.color;
                        ctx.beginPath();
                        ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.restore();
                    } else if (particle.type === 'text') {
                        ctx.save();
                        ctx.globalAlpha = particle.opacity;
                        ctx.font = `600 ${particle.size}px Inter`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        
                        const textWidth = ctx.measureText(particle.text).width;
                        const padding = 8;
                        const rectX = particle.x - textWidth / 2 - padding;
                        const rectY = particle.y - particle.size / 2 - padding;
                        const rectWidth = textWidth + padding * 2;
                        const rectHeight = particle.size + padding * 2;
                        
                        ctx.fillStyle = `rgba(255, 255, 255, ${0.9 * particle.opacity})`;
                        ctx.roundRect = ctx.roundRect || function(x, y, w, h, r) {
                            ctx.beginPath();
                            ctx.moveTo(x + r, y);
                            ctx.lineTo(x + w - r, y);
                            ctx.arcTo(x + w, y, x + w, y + r, r);
                            ctx.lineTo(x + w, y + h - r);
                            ctx.arcTo(x + w, y + h, x + w - r, y + h, r);
                            ctx.lineTo(x + r, y + h);
                            ctx.arcTo(x, y + h, x, y + h - r, r);
                            ctx.lineTo(x, y + r);
                            ctx.arcTo(x, y, x + r, y, r);
                            ctx.closePath();
                        };
                        
                        ctx.roundRect(rectX, rectY, rectWidth, rectHeight, rectHeight / 2);
                        ctx.fill();
                        
                        ctx.fillStyle = `rgba(30, 41, 59, ${particle.opacity})`;
                        ctx.fillText(particle.text, particle.x, particle.y);
                        ctx.restore();
                    }

                    return particle.opacity > 0;
                });

                if (particles.current.length > 0) {
                    animationFrame.current = requestAnimationFrame(() => animateParticles(ctx));
                }
            };

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;

                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                window.startParticleEffect = startParticleEffect;

                const handleResize = () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                };

                window.addEventListener('resize', handleResize);

                return () => {
                    window.removeEventListener('resize', handleResize);
                    if (animationFrame.current) {
                        cancelAnimationFrame(animationFrame.current);
                    }
                };
            }, []);

            return <canvas ref={canvasRef} className="particle-canvas" />;
        }

        // 外部API統合とレポート生成機能
        const ExternalAPIService = {
            // 天気予報API (ダミーデータ)
            getWeatherData: async (location = '東京') => {
                await new Promise(resolve => setTimeout(resolve, 1000)); // API呼び出しを模擬
                return {
                    location: location,
                    temperature: 22 + Math.floor(Math.random() * 10),
                    condition: ['晴れ', '曇り', '雨', '雪'][Math.floor(Math.random() * 4)],
                    humidity: 50 + Math.floor(Math.random() * 30),
                    forecast: '今日は暖かい一日になりそうです。',
                    source: 'OpenWeatherMap API'
                };
            },

            // 交通情報API (ダミーデータ)
            getTrafficData: async (route = '山手線') => {
                await new Promise(resolve => setTimeout(resolve, 800));
                return {
                    route: route,
                    status: ['正常運行', '遅延あり', '運転見合わせ'][Math.floor(Math.random() * 3)],
                    delay: Math.floor(Math.random() * 15),
                    info: '現在、一部区間で工事による徐行運転を行っています。',
                    source: 'JR東日本 列車運行情報'
                };
            },

            // ヘルスケアAPI (ダミーデータ)
            getHealthData: async () => {
                await new Promise(resolve => setTimeout(resolve, 600));
                return {
                    steps: 8500 + Math.floor(Math.random() * 3000),
                    heartRate: 70 + Math.floor(Math.random() * 20),
                    sleepHours: 6.5 + Math.random() * 2,
                    caloriesBurned: 1800 + Math.floor(Math.random() * 400),
                    source: 'Google Fit API'
                };
            },

            // ニュースAPI (ダミーデータ)
            getNewsData: async (category = 'technology') => {
                await new Promise(resolve => setTimeout(resolve, 1200));
                const newsItems = [
                    { title: 'AI技術の最新動向：2024年の注目トピック', summary: '機械学習とディープラーニングの進歩により...', source: 'TechNews24' },
                    { title: '電気自動車市場が急成長、バッテリー技術革新', summary: '全固体電池の実用化により航続距離が大幅改善...', source: 'EV Today' },
                    { title: '宇宙開発競争、民間企業の参入が加速', summary: 'SpaceXに続き、多くの企業が宇宙ビジネスに参入...', source: 'Space Report' }
                ];
                return {
                    category: category,
                    articles: newsItems,
                    totalResults: newsItems.length,
                    source: 'News API'
                };
            },

            // YouTubeデータ取得 (ダミーデータ)
            getYouTubeData: async (query) => {
                await new Promise(resolve => setTimeout(resolve, 900));
                return {
                    query: query,
                    videos: [
                        { title: `${query}の基礎講座`, channel: 'Learn Channel', views: '125K', url: 'https://youtube.com/watch?v=dummy1' },
                        { title: `${query}実践ガイド2024`, channel: 'Pro Tutorial', views: '89K', url: 'https://youtube.com/watch?v=dummy2' },
                        { title: `${query}最新トレンド解説`, channel: 'Tech Update', views: '67K', url: 'https://youtube.com/watch?v=dummy3' }
                    ],
                    source: 'YouTube Data API v3'
                };
            }
        };

        // Gemini API統合サービス
        const GeminiReportService = {
            generateReport: async (tags, articles, externalData, apiKey) => {
                if (!apiKey) {
                    console.warn('Gemini API key not provided, using mock response');
                    return GeminiReportService.getMockReport(tags, articles, externalData);
                }

                try {
                    const prompt = GeminiReportService.buildPrompt(tags, articles, externalData);

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Gemini API error: ${response.status}`);
                    }

                    const data = await response.json();
                    return {
                        content: data.candidates[0].content.parts[0].text,
                        tags: tags,
                        timestamp: new Date().toISOString(),
                        sources: externalData.map(data => data.source).filter(Boolean),
                        generatedBy: 'Gemini AI'
                    };
                } catch (error) {
                    console.error('Gemini API error:', error);
                    return GeminiReportService.getMockReport(tags, articles, externalData);
                }
            },

            buildPrompt: (tags, articles, externalData) => {
                let prompt = `以下のタグに関連するレポートを作成してください：${tags.join(', ')}\n\n`;

                prompt += `関連記事情報:\n`;
                articles.forEach((article, index) => {
                    prompt += `${index + 1}. ${article.title} - ${article.snippet}\n`;
                });

                if (externalData.length > 0) {
                    prompt += `\n外部データ情報:\n`;
                    externalData.forEach((data, index) => {
                        prompt += `${index + 1}. ${JSON.stringify(data, null, 2)}\n`;
                    });
                }

                prompt += `\n以下の形式でレポートを作成してください：
                1. エグゼクティブサマリー
                2. 現状分析
                3. トレンドと展望
                4. 推奨事項
                5. 参考リソース

                各セクションは具体的で実用的な内容にし、外部データがある場合はそれを活用してください。`;

                return prompt;
            },

            getMockReport: (tags, articles, externalData) => {
                const tagString = tags.join(' × ');
                return {
                    content: `# ${tagString} 統合レポート

## エグゼクティブサマリー
選択されたタグ「${tagString}」に関する包括的な分析レポートです。関連記事${articles.length}件と外部データ${externalData.length}件を基に、現状分析からトレンド予測まで詳細に解説します。

## 現状分析
${articles.slice(0, 3).map((article, index) =>
    `**${index + 1}. ${article.title}**\n${article.snippet}`
).join('\n\n')}

## トレンドと展望
現在の市場動向や技術進歩を踏まえ、今後12-24ヶ月の展望を分析します：

${externalData.map(data => {
    if (data.temperature !== undefined) {
        return `・天候データ: ${data.location}の気温${data.temperature}°C、${data.condition}の影響を考慮`;
    } else if (data.route !== undefined) {
        return `・交通状況: ${data.route}は${data.status}、遅延${data.delay}分の状況`;
    } else if (data.steps !== undefined) {
        return `・健康指標: 歩数${data.steps}歩、心拍数${data.heartRate}bpmの健康状態`;
    } else if (data.articles !== undefined) {
        return `・ニュース動向: ${data.category}分野で${data.totalResults}件の関連情報`;
    } else if (data.videos !== undefined) {
        return `・動画コンテンツ: ${data.query}関連で${data.videos.length}件の学習リソース`;
    }
    return '';
}).filter(Boolean).join('\n')}

## 推奨事項
1. **短期戦略**: 現在のトレンドを活用した取り組み
2. **中長期戦略**: 技術革新に対応した持続可能なアプローチ
3. **リスク管理**: 予想される課題への対策

## 参考リソース
${externalData.map(data => `・${data.source || 'External API'}`).join('\n')}
・関連記事 ${articles.length}件
・動画コンテンツ ${externalData.find(d => d.videos)?.videos?.length || 0}件

---
*このレポートは${new Date().toLocaleDateString('ja-JP')}に生成されました*`,
                    tags: tags,
                    timestamp: new Date().toISOString(),
                    sources: externalData.map(data => data.source).filter(Boolean),
                    generatedBy: 'Mock Gemini AI'
                };
            }
        };

        function App() {
            const [currentView, setCurrentView] = useState('map');
            const [collectedTags, setCollectedTags] = useState(new Map());
            const [tagLinks, setTagLinks] = useState([]);
            const [isArticleAreaExpanded, setIsArticleAreaExpanded] = useState(false);
            const [selectedTags, setSelectedTags] = useState([]);
            const [mapArticleAreaHeight, setMapArticleAreaHeight] = useState(50); // マップ画面での記事エリア高さ(%)
            const [isDragging, setIsDragging] = useState(false);
            const [dataLoaded, setDataLoaded] = useState(false);
            const [articles, setArticles] = useState([]);
            const [hierarchicalTags, setHierarchicalTags] = useState({});
            const [showBalanceInfo, setShowBalanceInfo] = useState(false);
            const [showCameraMenu, setShowCameraMenu] = useState(false);
            const [showVoiceMenu, setShowVoiceMenu] = useState(false);
            const [viewMode, setViewMode] = useState('grid');
            const [mapViewMode, setMapViewMode] = useState('list');
            const [favoritesViewMode, setFavoritesViewMode] = useState('grid'); // お気に入り集約画面専用
            const [selectedArticle, setSelectedArticle] = useState(null);
            const [showArticleDetail, setShowArticleDetail] = useState(false);
            const [showFavorites, setShowFavorites] = useState(false);
            const [showAiHelp, setShowAiHelp] = useState(false);
            const [previousView, setPreviousView] = useState(null); // 前の画面を追跡
            const [interestDepth, setInterestDepth] = useState(50); // 興味の深さ（0-100）
            //const [favoriteReports, setFavoriteReports] = useState([]); // お気に入りレポートリスト
            const [favoriteReports, setFavoriteReports] = useState(() => {
                // ローカルストレージからお気に入りを読み込み
                try {
                    const saved = localStorage.getItem('favoriteReports');
                    return saved ? JSON.parse(saved) : [];
                } catch (error) {
                    console.error('お気に入り読み込みエラー:', error);
                    return [];
                }
            }); // お気に入りレポートリスト
            const [showFavoritesList, setShowFavoritesList] = useState(false); // お気に入りリスト表示状態
            const [longPressedArticle, setLongPressedArticle] = useState(null); // 長押し状態の記事
            const [selectedFont, setSelectedFont] = useState(() => {
                // ローカルストレージからフォント設定を読み込み
                try {
                    const saved = localStorage.getItem('selectedFont');
                    return saved || 'normal';
                } catch (error) {
                    return 'normal';
                }
            }); // 選択されたフォント
            const [showFontSelector, setShowFontSelector] = useState(false); // フォント選択パネル表示状態

            // ビジュアルレポート生成機能の状態変数
            const [isGeneratingReport, setIsGeneratingReport] = useState(false);
            const [generatedReport, setGeneratedReport] = useState(null);
            const [reportLoadingProgress, setReportLoadingProgress] = useState(0);
            const [selectedKeywordDetail, setSelectedKeywordDetail] = useState(null);
            const [isLoadingKeywordDetail, setIsLoadingKeywordDetail] = useState(false);
            const [showAnalysisResults, setShowAnalysisResults] = useState(false); // 分析結果の表示制御
            // Gemini API Key（.env.localから動的に取得）
            let GEMINI_API_KEY = null;

            // .env.localファイルからAPIキーを読み込む関数
            const loadApiKeyFromEnv = async () => {
                try {
                    console.log('📁 .env.localファイル読み込み開始...');
                    const response = await fetch('./.env.local');
                    console.log('📄 .env.local レスポンス状態:', response.status, response.statusText);

                    if (!response.ok) {
                        throw new Error(`ファイル読み込み失敗: ${response.status}`);
                    }

                    const envContent = await response.text();
                    console.log('📝 .env.local ファイル内容:', envContent);

                    // GEMINI_API_KEY=... の行を探す
                    const lines = envContent.split('\n');
                    console.log('📋 行数:', lines.length, '行');

                    for (const line of lines) {
                        console.log('🔍 処理中の行:', line.trim());
                        if (line.startsWith('GEMINI_API_KEY=')) {
                            const keyValue = line.split('=')[1].trim();
                            GEMINI_API_KEY = keyValue;
                            console.log('✅ APIキー発見:', keyValue ? keyValue.substring(0, 10) + '...' : 'empty');
                            console.log('✅ .env.localからAPIキーを読み込みました');
                            console.log('🔑 設定されたAPIキー長さ:', GEMINI_API_KEY ? GEMINI_API_KEY.length : 0);
                            return GEMINI_API_KEY;
                        }
                    }

                    console.warn('⚠️ .env.localにGEMINI_API_KEYが見つかりません');
                    return null;
                } catch (error) {
                    console.error('❌ .env.local読み込みエラー:', error);

                    // フォールバック: 更新されたAPIキーを使用
                    GEMINI_API_KEY = 'AIzaSyAhi-WsLRswPCmaHsWQVzd1clBanpNZj3Y';
                    console.log('🔄 フォールバックAPIキーを使用:', GEMINI_API_KEY.substring(0, 10) + '...');
                    return GEMINI_API_KEY;
                }
            };

            // フォント選択肢
            const fontOptions = [
                { id: 'normal', name: '標準フォント', sample: 'あいうえお ABC' },
                { id: 'handwriting', name: 'Zen Kurenaido', sample: 'あいうえお ABC' },
                { id: 'klee', name: 'Klee One', sample: 'あいうえお ABC' },
                { id: 'yusei', name: 'Yusei Magic', sample: 'あいうえお ABC' },
                { id: 'hachi', name: 'Hachi Maru Pop', sample: 'あいうえお ABC' }
            ];

            // フォント変更機能
            const changeFont = (fontId) => {
                setSelectedFont(fontId);
                localStorage.setItem('selectedFont', fontId);
                setShowFontSelector(false);
            };

            // ビジュアル化レポート生成機能
            const generateVisualReport = async (selectedTags, articles) => {
                if (!selectedTags || selectedTags.length === 0) {
                    return;
                }

                // 前のキーワード詳細結果をクリア（分析結果の表示状態はそのまま）
                setSelectedKeywordDetail(null);
                setIsLoadingKeywordDetail(false);
                console.log('🔄 新しいレポート生成開始：キーワード詳細をリセット');

                setIsGeneratingReport(true);
                setReportLoadingProgress(0);

                try {
                    setReportLoadingProgress(20);

                    // 関連記事をフィルタリング
                    const relatedArticles = articles.filter(article =>
                        article.tags.some(tag => selectedTags.includes(tag))
                    );

                    setReportLoadingProgress(40);

                    // タグに関連するニュース・話題データを生成
                    const topicsData = await generateTopicsData(selectedTags);
                    const newsData = await generateNewsData(selectedTags);
                    const trendsData = await generateTrendsData(selectedTags);
                    const keywordsData = await generateKeywords(selectedTags);

                    setReportLoadingProgress(80);

                    // ビジュアルレポートを作成
                    const visualReport = {
                        tags: selectedTags,
                        articles: relatedArticles,
                        topics: topicsData,
                        news: newsData,
                        trends: trendsData,
                        keywords: keywordsData,
                        timestamp: new Date().toISOString(),
                        generatedBy: 'Visual Analytics System'
                    };

                    setReportLoadingProgress(100);
                    setGeneratedReport(visualReport);

                    console.log('📊 ビジュアルレポートが生成されました:', visualReport);
                    console.log('🔍 キーワード情報:', visualReport.keywords);
                    console.log('📈 トピック情報:', visualReport.topics);

                } catch (error) {
                    console.error('レポート生成エラー:', error);
                } finally {
                    setIsGeneratingReport(false);
                    setReportLoadingProgress(0);
                    console.log('🏁 generateVisualReport 関数終了');
                }
            };

            // トピックデータ生成
            const generateTopicsData = async (tags) => {
                await new Promise(resolve => setTimeout(resolve, 500));
                const mainTag = tags[0];

                const topicTemplates = {
                    'AI': ['機械学習', 'ディープラーニング', 'ChatGPT', '自動運転', 'ロボティクス'],
                    '技術': ['クラウド', 'セキュリティ', 'DevOps', 'ブロックチェーン', 'IoT'],
                    '料理': ['和食', '洋食', '中華', 'レシピ', '食材'],
                    '旅行': ['国内', '海外', 'グルメ', '観光地', 'ホテル'],
                    '健康': ['フィットネス', '栄養', '睡眠', 'メンタル', '予防医学'],
                    '動物': ['ペット', '野生動物', '保護', '飼育', '動物園']
                };

                const topics = topicTemplates[mainTag] || ['トレンド', 'ニュース', '話題', '注目', '人気'];

                return topics.map((topic, index) => ({
                    name: topic,
                    popularity: 70 + Math.random() * 30,
                    growth: (Math.random() - 0.5) * 20,
                    articleCount: Math.floor(Math.random() * 50) + 10,
                    color: `hsl(${(index * 60) % 360}, 70%, 60%)`
                }));
            };

            // ニュースデータ生成
            const generateNewsData = async (tags) => {
                await new Promise(resolve => setTimeout(resolve, 600));
                const mainTag = tags[0];

                const newsTemplates = {
                    'AI': [
                        { title: 'ChatGPTの新機能、ビジネス活用が加速', category: '技術', sentiment: 'positive' },
                        { title: 'AI規制法案、欧州で可決へ', category: '政治', sentiment: 'neutral' },
                        { title: '自動運転技術、2024年実用化へ前進', category: '自動車', sentiment: 'positive' }
                    ],
                    '料理': [
                        { title: '和食ブーム、海外で拡大中', category: 'グルメ', sentiment: 'positive' },
                        { title: '食材価格の上昇、家計を圧迫', category: '経済', sentiment: 'negative' },
                        { title: '新しい調理法、SNSで話題', category: 'トレンド', sentiment: 'positive' }
                    ],
                    '旅行': [
                        { title: '国内旅行需要、コロナ前水準に回復', category: '観光', sentiment: 'positive' },
                        { title: '円安の影響で海外旅行費用が上昇', category: '経済', sentiment: 'negative' },
                        { title: '新しい観光地、SNSで注目集める', category: 'トレンド', sentiment: 'positive' }
                    ]
                };

                const templates = newsTemplates[mainTag] || [
                    { title: `${mainTag}関連の最新動向`, category: 'ニュース', sentiment: 'neutral' },
                    { title: `${mainTag}業界に新たな変化`, category: 'ビジネス', sentiment: 'positive' },
                    { title: `${mainTag}技術の進歩が話題`, category: '技術', sentiment: 'positive' }
                ];

                return templates.map((news, index) => ({
                    ...news,
                    date: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    views: Math.floor(Math.random() * 10000) + 1000,
                    shares: Math.floor(Math.random() * 1000) + 100
                }));
            };

            // トレンドデータ生成
            const generateTrendsData = async (tags) => {
                await new Promise(resolve => setTimeout(resolve, 400));
                return tags.map((tag, index) => {
                    const baseValue = 50;
                    const trend = Array.from({ length: 7 }, (_, i) => ({
                        date: new Date(Date.now() - (6 - i) * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        value: baseValue + Math.sin(i * 0.5) * 20 + Math.random() * 10
                    }));

                    return {
                        tag,
                        trend,
                        currentValue: trend[trend.length - 1].value,
                        change: trend[trend.length - 1].value - trend[trend.length - 2].value,
                        color: `hsl(${(index * 120) % 360}, 65%, 55%)`
                    };
                });
            };

            // Gemini APIを使用したWebトレンド分析サービス
            const GeminiTrendAnalyzer = {
                // Gemini APIを使用して実際のトレンドを分析
                analyzeRealTimeTrends: async (tag, apiKey) => {
                    if (!apiKey) {
                        console.warn('Gemini API key not provided, using fallback data');
                        return WebTrendService.getFallbackTrends(tag);
                    }

                    try {
                        const prompt = `
${tag}に関する2024年9月時点の最新トレンド情報を分析してください。

【分析対象・情報源】
- X (Twitter): ツイート、ハッシュタグ、リツイート数、トレンド入り
- Instagram: 投稿数、ハッシュタグ使用、ストーリーズ、リール動画
- TikTok: 動画投稿、チャレンジ、音楽トレンド
- YouTube: 動画再生数、チャンネル登録者増加、コメント数
- Webサイト・ブログ: 記事更新、アクセス数、検索流入
- ECサイト: 商品売上、レビュー数、検索ランキング
- 公式サイト: 発表・リリース情報、アップデート
- ニュースメディア: 記事数、検索数、報道頻度
- Google検索: 検索ボリューム、関連検索語、サジェスト
- Wikipedia: ページビュー、編集頻度
- その他SNS: Facebook、LinkedIn、Reddit、Discord等

【重要な指示】
- SNSでの実際の言及数・エンゲージメント数に基づく分析
- ハッシュタグ、バズワード、ミーム等のSNS特有の現象を含める
- 実際にトレンドになっているもののみを含める（無理に8個埋める必要なし）
- 関連キーワードは「${tag}」という単語を避けて、実際に関連する具体的な名前・サービス・技術を記載
- トレンドがない場合は空配列[]を返す
- 実在しないものは含めない

以下の形式でJSONのみで回答してください：

{
  "trending": ["SNSで急上昇中の具体的なキーワード・ハッシュタグ（0-8個）"],
  "related": ["実際に関連する具体的なサービス名・技術名・人名・企業名（0-8個）"],
  "hot": ["SNS・メディアで話題の具体的なトピック・イベント・ニュース（0-6個）"],
  "analysis": "SNS・Web上での${tag}分野の動向分析（200文字以内、エンゲージメント・言及数等の実際の状況）",
  "sources": ["X", "Instagram", "TikTok", "YouTube", "Google Trends", "Wikipedia", "ニュースメディア", "公式サイト"]
}

例：
「アニメ」→ related: ["Netflix", "呪術廻戦", "宮崎駿", "スタジオジブリ", "鬼滅の刃", "東映アニメーション"]
「AI」→ related: ["ChatGPT", "OpenAI", "Claude", "Gemini", "機械学習", "ディープラーニング"]

※「${tag}関連」「${tag}ニュース」等の表現は使わず、具体名のみ記載してください。`;

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: prompt
                                    }]
                                }]
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`Gemini API error: ${response.status} ${response.statusText}`);
                        }

                        const data = await response.json();
                        console.log('📡 Gemini API レスポンス:', data);

                        if (!data.candidates || !data.candidates[0]) {
                            throw new Error('No candidates in Gemini API response');
                        }

                        const content = data.candidates[0].content.parts[0].text;
                        console.log('📝 Gemini API コンテンツ:', content);

                        // JSONを抽出（マークダウンのコードブロックを除去）
                        const jsonMatch = content.match(/```json\s*(\{[\s\S]*?\})\s*```/) || content.match(/(\{[\s\S]*?\})/);

                        if (jsonMatch) {
                            try {
                                const trendData = JSON.parse(jsonMatch[1]);
                                console.log('🤖 Gemini APIから取得した本物のトレンドデータ:', trendData);
                                return trendData;
                            } catch (parseError) {
                                console.error('JSON parsing error:', parseError);
                                throw new Error('Failed to parse JSON from Gemini API');
                            }
                        } else {
                            console.error('No JSON found in response:', content);
                            throw new Error('Invalid JSON format from Gemini API');
                        }

                    } catch (error) {
                        console.error('Gemini API トレンド分析エラー:', error);
                        return WebTrendService.getFallbackTrends(tag);
                    }
                },

                // キーワードの詳細説明を取得
                explainKeywordTrend: async (keyword, category, apiKey) => {
                    console.log('🔍 explainKeywordTrend 開始:', { keyword, category, hasApiKey: !!apiKey });

                    if (!apiKey) {
                        console.log('⚠️ APIキーなし、フォールバックデータを返却');
                        return {
                            keyword: keyword,
                            explanation: `${keyword}に関する基本的な情報です。`,
                            reasons: ['人気上昇中', '注目度が高い', 'SNSで話題'],
                            details: `${keyword}についての詳細な分析データが利用できません。`,
                            sources: ['Static Data']
                        };
                    }

                    try {
                        console.log('📡 Gemini API リクエスト準備中...');
                        const prompt = `
キーワード「${keyword}」について、SNS・Web上の最新情報を網羅的に分析し、Wikipedia風の詳細で専門的な解説を作成してください。

【分析対象・情報源（網羅的）】
- X (Twitter): ツイート数、ハッシュタグ使用頻度、リツイート・いいね数、トレンド入り履歴
- Instagram: 投稿数、ハッシュタグ数、ストーリーズ、リール再生数、インフルエンサー言及
- TikTok: 動画投稿数、再生数、チャレンジ動画、音楽トレンド、ハッシュタグ
- YouTube: 動画数、再生数、チャンネル登録者数、コメント数、関連動画
- Webサイト・ブログ: 記事数、PV数、検索流入、バックリンク、言及頻度
- ECサイト: 商品売上、レビュー数、検索ランキング、価格動向
- 公式サイト: プレスリリース、アップデート情報、発表内容
- ニュースメディア: 記事数、検索数、報道頻度、メディア露出
- Google検索: 検索ボリューム、関連検索語、サジェスト、トレンド
- Wikipedia: ページビュー、編集頻度、新規作成、更新履歴
- Reddit: 投稿数、アップボート、コメント数、サブレディット活動
- Discord・Slack: コミュニティでの言及、議論頻度
- LinkedIn: ビジネス関連の投稿、専門家の言及
- Facebook: シェア数、コメント数、グループでの議論
- 各種フォーラム・掲示板: 投稿数、議論の活発さ

2024年9月時点の最新情報を基に、以下の形式でJSONで回答してください：

{
  "keyword": "${keyword}",
  "explanation": "概要・定義（150-200文字、Wikipedia風の導入文、SNS・Web上での位置づけを含む）",
  "reasons": ["SNS・Web上で注目されている具体的な理由6-8個（エンゲージメント数、バズった理由、話題の発端など）"],
  "details": "詳細な解説（500-800文字、歴史・背景・現状・SNS・Web上での影響を含むWikipedia風の記述）",
  "trend_type": "トレンドの性質（技術革新、社会現象、経済動向、エンターテイメント、政治・社会問題、SNSバズ、ミームなど）",
  "timeline": "重要な時期・節目（具体的な日付や期間、SNS上でのバズ時期を含む）",
  "related_events": ["関連する重要な出来事・発表・ニュース・SNSバズ4-6個（具体的な事実）"],
  "key_figures": ["関連する重要人物・企業・組織2-3個"],
  "impact": "社会・業界への影響（100-150文字）",
  "sources": ["X", "Instagram", "TikTok", "YouTube", "Google Trends", "Wikipedia", "ニュースメディア", "公式サイト"]
}

【重要な指示】
- SNS・Web上での実際の数値・エンゲージメントデータに基づく分析
- ハッシュタグ、バズワード、ミーム、チャレンジ等のSNS特有の現象を含める
- インフルエンサー・著名人の言及、拡散状況も考慮
- Wikipedia風の客観的で事実に基づいた記述
- 具体的な数値、日付、固有名詞を含める
- 推測ではなく実際の情報のみ使用
- 専門的かつ分かりやすい説明
- 中立的な観点で記述`;

                        console.log('🚀 Gemini API リクエスト送信...');
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: prompt
                                    }]
                                }]
                            })
                        });

                        console.log('📩 API レスポンス状態:', response.status, response.statusText);

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('❌ Gemini API エラーレスポンス:', errorText);
                            throw new Error(`Gemini API error: ${response.status} - ${errorText}`);
                        }

                        const data = await response.json();
                        console.log('📡 キーワード詳細 API レスポンス:', data);

                        if (!data.candidates || !data.candidates[0]) {
                            throw new Error('No candidates in response');
                        }

                        const content = data.candidates[0].content.parts[0].text;
                        console.log('📝 キーワード詳細 コンテンツ:', content);

                        // JSONを抽出
                        const jsonMatch = content.match(/```json\s*(\{[\s\S]*?\})\s*```/) || content.match(/(\{[\s\S]*?\})/);

                        if (jsonMatch) {
                            try {
                                const detailData = JSON.parse(jsonMatch[1]);
                                console.log('🔍 キーワード詳細データ:', detailData);
                                return detailData;
                            } catch (parseError) {
                                console.error('JSON parsing error:', parseError);
                                throw new Error('Failed to parse JSON response');
                            }
                        } else {
                            console.error('No JSON found in response:', content);

                            // フォールバック用の詳細データを生成
                            return {
                                keyword: keyword,
                                explanation: `${keyword}は現在注目を集めているトピックです。`,
                                reasons: ['検索数の増加', 'メディア露出の拡大', 'ソーシャルメディアでの言及増加'],
                                details: `${keyword}に関する詳細な分析。現在このキーワードは様々な要因により注目を集めており、トレンドとして浮上しています。`,
                                trend_type: category,
                                timeline: '最近',
                                related_events: ['関連イベント情報取得中'],
                                sources: ['Fallback Analysis']
                            };
                        }

                    } catch (error) {
                        console.error('キーワード詳細取得エラー:', error);
                        return {
                            keyword: keyword,
                            explanation: `${keyword}に関する詳細情報を取得中にエラーが発生しました。`,
                            reasons: ['データ取得エラー'],
                            details: `${keyword}についての詳細な分析が一時的に利用できません。`,
                            sources: ['Error Fallback']
                        };
                    }
                }
            };

            // フォールバックデータサービス
            const WebTrendService = {
                // フォールバックデータ（Gemini API不使用時）
                getFallbackTrends: (tag) => {
                    const realTrendData = {
                        'アニメ': {
                            trending: ['呪術廻戦', 'チェンソーマン', 'スパイファミリー', '鬼滅の刃', 'ワンピース', '僕のヒーローアカデミア', '進撃の巨人'],
                            related: ['声優', 'アニメソング', 'コスプレ', 'フィギュア', 'マンガ', 'ライトノベル', '聖地巡礼', 'アニメ映画'],
                            hot: ['AIアニメ', 'VTuberアニメ', 'Netflix独占', 'グローバル配信', 'アニメ業界DX', '3DCGアニメ']
                        },
                        'AI': {
                            trending: ['ChatGPT-4', 'Claude-3', 'Gemini Ultra', 'GPT-5', 'Sora', 'Midjourney V6', 'Stable Diffusion'],
                            related: ['プロンプトエンジニアリング', '機械学習', 'ディープラーニング', 'LangChain', 'ベクトルデータベース', 'RAG'],
                            hot: ['AGI開発', 'AI規制法', 'マルチモーダルAI', 'AI Agent', 'ファインチューニング', 'AIガバナンス']
                        },
                        '技術': {
                            trending: ['Next.js 14', 'React 19', 'TypeScript 5', 'Tailwind CSS', 'Docker', 'Kubernetes', 'AWS'],
                            related: ['フロントエンド', 'バックエンド', 'DevOps', 'クラウド', 'マイクロサービス', 'API設計'],
                            hot: ['WebAssembly', 'Edge Computing', 'Serverless', 'JAMstack', 'Low Code', 'No Code']
                        },
                        '料理': {
                            trending: ['韓国料理', 'プロテインレシピ', '時短料理', 'ヘルシー弁当', 'グルテンフリー', '発酵食品', 'スープカレー'],
                            related: ['レシピ動画', '料理教室', '調理器具', '食材宅配', '栄養バランス', '食品ロス対策'],
                            hot: ['完全栄養食', 'ミールキット', '培養肉', 'フードテック', 'サステナブル食材', 'AI料理']
                        },
                        '旅行': {
                            trending: ['国内旅行', '温泉巡り', 'グランピング', 'ワーケーション', '一人旅', 'キャンプ', '車中泊'],
                            related: ['ホテル予約', '航空券', 'レンタカー', '観光地', 'お土産', 'グルメ旅'],
                            hot: ['メタバース旅行', 'サステナブルツーリズム', 'オーバーツーリズム対策', 'デジタルノマド', 'リモートワーク旅行']
                        },
                        '健康': {
                            trending: ['筋トレ', 'ヨガ', 'ランニング', 'プロテイン', 'サウナ', 'マインドフルネス', '睡眠改善'],
                            related: ['フィットネス', '栄養管理', 'サプリメント', 'ストレッチ', '瞑想', 'メンタルケア'],
                            hot: ['パーソナライズ医療', 'ウェアラブル', 'テレヘルス', '予防医学', 'デジタルセラピー', 'ヘルステック']
                        },
                        '動物': {
                            trending: ['猫カフェ', '犬の散歩', 'ペット保険', 'キャットフード', 'ドッグラン', 'ペット同伴旅行'],
                            related: ['獣医師', 'トリミング', 'ペットホテル', 'しつけ教室', 'ペット用品', 'アニマルセラピー'],
                            hot: ['ペットテック', 'AIペット診断', 'ペット見守りカメラ', '保護猫活動', '動物愛護法改正']
                        }
                    };

                    return realTrendData[tag] || null;
                },

                // YouTube、Twitter、Googleトレンドを模擬したデータ取得
                fetchSocialTrends: async (tag) => {
                    await new Promise(resolve => setTimeout(resolve, 600));

                    // 実際のソーシャルメディアトレンドを模擬
                    const socialTrends = {
                        'アニメ': ['#呪術廻戦', '#チェンソーマン', '#アニメ好きと繋がりたい', '#今期のアニメ'],
                        'AI': ['#ChatGPT', '#AI革命', '#生成AI', '#プロンプトエンジニアリング'],
                        '技術': ['#プログラミング学習', '#エンジニア転職', '#Web開発', '#技術書'],
                        '料理': ['#おうちごはん', '#時短レシピ', '#料理好きと繋がりたい', '#手作り弁当'],
                        '旅行': ['#国内旅行', '#温泉旅行', '#一人旅', '#旅行好きと繋がりたい'],
                        '健康': ['#筋トレ', '#ダイエット', '#健康管理', '#ヨガ'],
                        '動物': ['#猫', '#犬', '#ペット', '#動物好きと繋がりたい']
                    };

                    return socialTrends[tag] || [];
                }
            };

            // キーワード生成機能（Gemini API統合）
            const generateKeywords = async (tags) => {
                const mainTag = tags[0];
                console.log('🎯 generateKeywords 開始:', { tags, mainTag });
                console.log('🔑 generateKeywords時点のAPIキー状態:', {
                    hasKey: !!GEMINI_API_KEY,
                    keyLength: GEMINI_API_KEY ? GEMINI_API_KEY.length : 0,
                    keyStart: GEMINI_API_KEY ? GEMINI_API_KEY.substring(0, 10) + '...' : 'なし'
                });

                try {
                    // 常にGemini APIを使用してリアルタイムトレンド分析
                    if (GEMINI_API_KEY && GEMINI_API_KEY !== 'YOUR_ACTUAL_GEMINI_API_KEY_HERE') {
                        console.log('🔍 Gemini APIを使用してトレンド分析中...', mainTag);
                        const geminiTrends = await GeminiTrendAnalyzer.analyzeRealTimeTrends(mainTag, GEMINI_API_KEY);
                        console.log('✅ Gemini トレンド分析結果:', geminiTrends);

                        return {
                            trending: geminiTrends.trending || [],
                            related: geminiTrends.related || [],
                            hot: geminiTrends.hot || [],
                            analysis: geminiTrends.analysis || '',
                            sources: geminiTrends.sources || ['Gemini AI Analysis']
                        };
                    } else {
                        console.log('❌ APIキーが無効、キーワード生成で再読み込みを試行...');
                        // APIキーの再読み込みを試行
                        const reloadedKey = await loadApiKeyFromEnv();
                        if (reloadedKey && reloadedKey !== 'YOUR_ACTUAL_GEMINI_API_KEY_HERE') {
                            console.log('🔄 APIキー再読み込み成功、Gemini トレンド分析を実行...');
                            const geminiTrends = await GeminiTrendAnalyzer.analyzeRealTimeTrends(mainTag, reloadedKey);
                            console.log('✅ Gemini トレンド分析結果:', geminiTrends);

                            return {
                                trending: geminiTrends.trending || [],
                                related: geminiTrends.related || [],
                                hot: geminiTrends.hot || [],
                                analysis: geminiTrends.analysis || '',
                                sources: geminiTrends.sources || ['Gemini AI Analysis']
                            };
                        } else {
                            console.log('❌ APIキー再読み込みも失敗、フォールバックデータを使用');
                        }
                    }

                    // フォールバックデータを使用（開発・デモ用）
                    console.log('📝 フォールバックデータを使用してトレンド生成中...');
                    const fallbackTrends = WebTrendService.getFallbackTrends(mainTag);

                    if (fallbackTrends) {
                        return {
                            trending: shuffleArray(fallbackTrends.trending).slice(0, 8),
                            related: shuffleArray(fallbackTrends.related).slice(0, 8),
                            hot: shuffleArray(fallbackTrends.hot).slice(0, 6),
                            analysis: `${mainTag}分野の現在のトレンド分析データです。`,
                            sources: ['Static Data', 'Trend Database']
                        };
                    }

                } catch (error) {
                    console.error('キーワード生成エラー:', error);

                    // エラー時はフォールバックデータを使用
                    const fallbackTrends = WebTrendService.getFallbackTrends(mainTag);
                    if (fallbackTrends) {
                        return {
                            trending: shuffleArray(fallbackTrends.trending).slice(0, 8),
                            related: shuffleArray(fallbackTrends.related).slice(0, 8),
                            hot: shuffleArray(fallbackTrends.hot).slice(0, 6),
                            analysis: `${mainTag}分野のトレンド分析データです。`,
                            sources: ['Fallback Data']
                        };
                    }
                }

                // 最終フォールバック: デフォルトキーワード
                return {
                    trending: [`${mainTag}最新`, `${mainTag}人気`, `${mainTag}ランキング`, `${mainTag}2024`, `${mainTag}トレンド`],
                    related: [`${mainTag}関連`, `${mainTag}情報`, `${mainTag}ニュース`, `${mainTag}まとめ`, `${mainTag}解説`],
                    hot: [`${mainTag}話題`, `${mainTag}注目`, `${mainTag}急上昇`, `${mainTag}バズり`, `${mainTag}流行`],
                    analysis: `${mainTag}に関する基本的なキーワード分析です。`,
                    sources: ['Default Keywords']
                };
            };

            // 配列をシャッフルする関数
            const shuffleArray = (array) => {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            };

            // キーワード詳細を取得する関数（簡略版）
            const fetchKeywordDetail = async (keyword, category) => {
                console.log('🔍 fetchKeywordDetail 開始:', { keyword, category });
                setIsLoadingKeywordDetail(true);

                // APIキーの状態をチェック
                console.log('🔑 fetchKeywordDetail時点のAPIキー状態:', {
                    GEMINI_API_KEY_defined: typeof GEMINI_API_KEY,
                    GEMINI_API_KEY_value: GEMINI_API_KEY ? GEMINI_API_KEY.substring(0, 10) + '...' : 'null/undefined',
                    GEMINI_API_KEY_length: GEMINI_API_KEY ? GEMINI_API_KEY.length : 0
                });

                // 短時間のローディング表示
                await new Promise(resolve => setTimeout(resolve, 1000));

                try {
                    console.log('🔍 キーワード詳細取得:', keyword, category);

                    // まずはローカルで詳細データを生成（確実に動作）
                    const localDetail = generateLocalKeywordDetail(keyword, category);

                    // Gemini APIを試行（エラーでも続行）
                    try {
                        console.log('🔑 APIキーチェック:', {
                            hasKey: !!GEMINI_API_KEY,
                            keyLength: GEMINI_API_KEY ? GEMINI_API_KEY.length : 0,
                            keyStart: GEMINI_API_KEY ? GEMINI_API_KEY.substring(0, 10) + '...' : 'なし'
                        });

                        if (GEMINI_API_KEY && GEMINI_API_KEY !== 'YOUR_ACTUAL_GEMINI_API_KEY_HERE') {
                            console.log('🤖 Gemini API 詳細分析を試行中...', keyword, category);
                            const geminiDetail = await GeminiTrendAnalyzer.explainKeywordTrend(keyword, category, GEMINI_API_KEY);
                            console.log('✅ Gemini API レスポンス受信:', geminiDetail);
                            setSelectedKeywordDetail(geminiDetail);
                            return;
                        } else {
                            console.log('❌ APIキーが無効、再読み込みを試行...');
                            // APIキーの再読み込みを試行
                            const reloadedKey = await loadApiKeyFromEnv();
                            if (reloadedKey && reloadedKey !== 'YOUR_ACTUAL_GEMINI_API_KEY_HERE') {
                                console.log('🔄 APIキー再読み込み成功、Gemini API を試行...');
                                const geminiDetail = await GeminiTrendAnalyzer.explainKeywordTrend(keyword, category, reloadedKey);
                                console.log('✅ Gemini API レスポンス受信:', geminiDetail);
                                setSelectedKeywordDetail(geminiDetail);
                                return;
                            } else {
                                console.log('❌ APIキー再読み込みも失敗、ローカルデータを使用');
                            }
                        }
                    } catch (apiError) {
                        console.warn('❌ Gemini API エラー、ローカルデータを使用:', apiError);
                    }

                    // ローカルデータを使用
                    setSelectedKeywordDetail(localDetail);

                } catch (error) {
                    console.error('キーワード詳細取得エラー:', error);

                    // 最終フォールバック
                    setSelectedKeywordDetail({
                        keyword: keyword,
                        explanation: `${keyword}は現在注目されているキーワードです。`,
                        reasons: ['検索数の増加', 'メディア露出', 'SNS話題'],
                        details: `${keyword}に関する基本的な分析情報です。このキーワードは様々な要因により注目を集めています。`,
                        trend_type: category,
                        timeline: '最近',
                        related_events: ['関連情報収集中'],
                        sources: ['Local Analysis']
                    });
                } finally {
                    setIsLoadingKeywordDetail(false);
                }
            };

            // ローカルでキーワード詳細を生成する関数
            const generateLocalKeywordDetail = (keyword, category) => {
                const keywordDetails = {
                    '呪術廻戦': {
                        explanation: '呪術廻戦は、芥見下々による日本の漫画作品を原作とするアニメーション作品。超自然的な要素と現代的な設定を組み合わせた独特の世界観で、2024年現在も高い人気を維持している。',
                        reasons: ['アニメ第3期制作決定発表', 'スマートフォンゲーム「呪術廻戦 幻夜闘」配信開始', '劇場版第2弾の興行収入が100億円突破', '海外配信での視聴数記録更新', 'コラボレーション商品の売上好調', '声優イベントの大規模開催'],
                        details: '呪術廻戦は2018年より週刊少年ジャンプで連載開始され、2020年にテレビアニメ化。MAPPAによるアニメーション制作で話題となり、独特な呪術設定と現代社会を舞台にしたストーリー展開が評価されている。主人公虎杖悠仁を中心とした学園バトル要素と、深刻な社会問題を扱うテーマ性のバランスが特徴的。2024年にはアニメ第3期の制作が決定し、原作漫画も最終章に向けて物語が加速している。',
                        trend_type: 'エンターテイメント',
                        timeline: '2024年7月：第3期制作発表、2024年8月：スマホゲーム配信開始',
                        related_events: ['渋谷事変編アニメ化完結', '原作漫画最終章突入', '海外展開の本格化', 'VRコンテンツ制作発表'],
                        key_figures: ['芥見下々（原作者）', 'MAPPA（アニメーション制作）', '榎木淳弥（虎杖悠仁役）'],
                        impact: 'アニメ業界における3DCGと2Dアニメーションの融合技術の発展に貢献。海外市場でのジャンプ作品の地位向上にも大きく寄与し、関連商品市場の拡大を牽引している。',
                        sources: ['週刊少年ジャンプ公式', 'MAPPA公式サイト', 'Netflix Japan', 'オリコンニュース']
                    },
                    'チェンソーマン': {
                        explanation: 'アニメ第2期の制作発表と新展開により話題沸騰中',
                        reasons: ['アニメ第2期制作発表', '原作漫画の新章開始', '実写映画化の噂', 'フィギュア新商品発売', 'Twitterでのバズ拡散'],
                        details: 'チェンソーマンは独特な世界観とキャラクターで人気を博している作品です。アニメ第1期の成功を受けて第2期の制作が発表され、ファンの間で大きな期待と話題を呼んでいます。'
                    },
                    'スパイファミリー': {
                        explanation: '家族をテーマにした心温まるストーリーで幅広い層から支持',
                        reasons: ['アニメ新エピソード放送', '家族層に人気拡大', 'グッズ展開の充実', '海外配信好調', 'ミームとしての拡散'],
                        details: 'スパイファミリーは偽装家族の日常を描いた作品で、コメディとアクションのバランスが絶妙です。特に「アーニャ」キャラクターの人気が高く、様々なメディア展開が行われています。'
                    }
                };

                const detail = keywordDetails[keyword] || {
                    explanation: `${keyword}は現在${category}として注目を集めています`,
                    reasons: ['検索トレンド上昇', 'メディア露出増加', 'SNSでの言及拡大'],
                    details: `${keyword}に関する詳細な分析。現在このキーワードは様々な要因により${category}として浮上しています。`
                };

                return {
                    keyword: keyword,
                    explanation: detail.explanation,
                    reasons: detail.reasons,
                    details: detail.details,
                    trend_type: detail.trend_type || category,
                    timeline: detail.timeline || '2024年夏頃から',
                    related_events: detail.related_events || ['関連イベント開催', '新商品発売', 'メディア報道'],
                    key_figures: detail.key_figures || ['関連企業・人物'],
                    impact: detail.impact || `${keyword}は関連業界や社会に対して一定の影響を与えている。`,
                    sources: detail.sources || ['Local Trend Database', 'Social Media Analysis']
                };
            };

            // 分析結果を完全にクリアする関数
            const clearAllAnalysisResults = () => {
                console.log('🧹 すべての分析結果をクリア');
                setSelectedKeywordDetail(null);
                setIsLoadingKeywordDetail(false);
                setGeneratedReport(null);
                setIsGeneratingReport(false);
                setReportLoadingProgress(0);
                setShowAnalysisResults(false); // 分析結果を非表示に
            };

            // キーワードクリック時の処理（詳細表示のみ）
            const handleKeywordClick = async (keyword, category = '話題') => {
                console.log('🔍 キーワードクリック:', keyword);

                // キーワード詳細を取得して表示（自動クローズしない）
                await fetchKeywordDetail(keyword, category);
            };

            // キーワードから新しいレポート生成の処理（分離）
            const handleGenerateReportFromKeyword = async (keyword) => {
                console.log('🔄 新しいレポート生成開始:', keyword);

                // すべての分析結果をクリア
                clearAllAnalysisResults();

                // 新しいタグとして設定
                const newTags = [keyword];
                setSelectedTags(newTags);

                // 新しいレポートを生成
                await generateVisualReport(newTags, articles);
            };

            // 長押し機能
            const handleLongPressStart = (reportId) => {
                const timer = setTimeout(() => {
                    setLongPressedArticle(reportId);
                }, 500); // 500ms長押しで削除ボタン表示
                return timer;
            };

            const handleLongPressEnd = (timer) => {
                clearTimeout(timer);
            };

            // お気に入り記事削除
            const deleteArticleFromFavorites = (reportId, event) => {
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }

                setFavoriteReports(prev => {
                    const updatedReports = prev.filter(report => report.id !== reportId);
                    try {
                        localStorage.setItem('favoriteReports', JSON.stringify(updatedReports));
                        console.log('🗑️ お気に入り記事削除完了:', reportId);
                    } catch (error) {
                        console.error('お気に入り削除保存エラー:', error);
                    }
                    return updatedReports;
                });

                // 長押し状態をリセット
                setLongPressedArticle(null);
            };

            // 初期タグの設定
            const initializeDefaultTags = () => {
                const defaultTags = new Map();
                const defaultLinks = [];
                
                // 一般的な大カテゴリタグを事前配置
                const initialTags = [
                    { id: 'AI', size: 1.5, x: 200, y: 150 },
                    { id: '技術', size: 1.3, x: 350, y: 200 },
                    { id: 'ビジネス', size: 1.2, x: 500, y: 150 },
                    { id: '料理', size: 1.0, x: 150, y: 300 },
                    { id: '旅行', size: 1.1, x: 400, y: 350 },
                    { id: '動物', size: 0.9, x: 600, y: 280 },
                    { id: 'SDGs', size: 1.1, x: 300, y: 100 },
                    { id: 'ファッション', size: 0.8, x: 550, y: 400 }
                ];
                
                initialTags.forEach(tag => {
                    defaultTags.set(tag.id, {
                        id: tag.id,
                        count: 1,
                        size: tag.size,
                        x: tag.x,
                        y: tag.y
                    });
                });
                
                // タグ間の関連性リンク
                const tagRelations = [
                    ['AI', '技術'],
                    ['技術', 'ビジネス'],
                    ['SDGs', 'ビジネス'],
                    ['旅行', '料理'],
                    ['ファッション', 'ビジネス']
                ];
                
                tagRelations.forEach(([source, target]) => {
                    defaultLinks.push({ source, target });
                });
                
                return { defaultTags, defaultLinks };
            };
            
            // 記事の話題性スコアを計算（初期読み込み時のみ）
            const calculateTopicalityScore = (article) => {
                let score = 0;
                
                // タグ数による基本スコア（多いほど話題性が高い）
                score += article.tags.length * 15;
                
                // 特定の話題性の高いタグによる追加スコア
                const hotTags = ['AI', '技術', 'ビジネス', 'SDGs', 'イノベーション'];
                const trendingTags = article.tags.filter(tag => hotTags.includes(tag));
                score += trendingTags.length * 25;
                
                // ランダム要素（記事の多様性を確保）
                score += Math.random() * 20;
                
                return Math.max(10, Math.min(100, score)); // 10-100の範囲
            };

            // 話題性スコアに基づくグリッドサイズを決定（すべて正方形の組み合わせ）
            const getStaticGridSize = (score) => {
                if (score >= 80) return { gridColumn: 'span 2', gridRow: 'span 2' }; // 大正方形 (2x2)
                if (score >= 60) return { gridColumn: 'span 2', gridRow: 'span 2' }; // 大正方形 (2x2)
                if (score >= 40) return { gridColumn: 'span 1', gridRow: 'span 1' }; // 小正方形 (1x1)
                return { gridColumn: 'span 1', gridRow: 'span 1' }; // 小正方形 (1x1)
            };

            // 興味の深さ情報を取得する関数
            const getDepthInfo = (depth) => {
                if (depth <= 30) {
                    return {
                        label: '私的興味',
                        description: '個人的な趣味や関心事に焦点を当てた記事が中心となります。'
                    };
                } else if (depth <= 70) {
                    return {
                        label: 'バランス',
                        description: '様々なジャンルの記事をバランス良く表示します。'
                    };
                } else {
                    return {
                        label: 'パーソナル',
                        description: 'ビジネス・技術系の専門的な記事が中心となります。'
                    };
                }
            };

            // お気に入りレポート管理（トグル機能付き）
            const toggleFavorites = (reportData, event) => {
                console.log('🔖 toggleFavorites呼び出し:', reportData);
                console.log('📍 呼び出し元のスタックトレース:', new Error().stack);
                const newReport = {
                    title: reportData.title,
                    type: reportData.type,
                    tags: reportData.tags,
                    timestamp: new Date().toISOString(),
                    articleCount: reportData.articleCount
                };

                // 記事データがある場合のみ追加
                if (reportData.articleData) {
                    newReport.articleData = reportData.articleData;
                }
                
                setFavoriteReports(prev => {
                    // 既存チェック（記事の場合はタイトルで、レポートの場合はタグで判定）
                    const existingIndex = prev.findIndex(report => {
                        if (report.type === 'article' && newReport.type === 'article') {
                            // 記事の場合はタイトルで重複チェック
                            return report.title === newReport.title;
                        } else if (report.type === 'aggregated' && newReport.type === 'aggregated') {
                            // 集約レポートの場合はタグで重複チェック
                            return JSON.stringify(report.tags.sort()) === JSON.stringify(newReport.tags.sort());
                        }
                        return false;
                    });

                    let updatedReports;
                    if (existingIndex !== -1) {
                        // 既存の場合は削除（解除）
                        if (event) {
                            showCompletionAnimation(event.target, 'delete');
                        }
                        updatedReports = prev.filter((_, index) => index !== existingIndex);
                    } else {
                        // 新規の場合は追加
                        const reportId = `${reportData.type}_${reportData.tags.join('_')}_${Date.now()}`;
                        const reportWithId = { ...newReport, id: reportId };

                        if (event) {
                            showCompletionAnimation(event.target, 'success');
                        }
                        updatedReports = [...prev, reportWithId];
                    }

                    // ローカルストレージに保存
                    try {
                        localStorage.setItem('favoriteReports', JSON.stringify(updatedReports));
                        console.log('💾 お気に入り保存完了:', updatedReports);
                        console.log('📊 現在のお気に入り数:', updatedReports.length);
                        console.log('📝 記事タイプの数:', updatedReports.filter(r => r.type === 'article').length);
                        console.log('📋 集約タイプの数:', updatedReports.filter(r => r.type === 'aggregated').length);
                    } catch (error) {
                        console.error('お気に入り保存エラー:', error);
                    }

                    return updatedReports;
                });
            };
            
            // 旧関数名との互換性のため
            const addToFavorites = toggleFavorites;
            
            // お気に入り状態チェック
            const isFavorite = (reportData) => {
                return favoriteReports.some(report => {
                    if (report.type === 'article' && reportData.type === 'article') {
                        // 記事の場合はタイトルで判定
                        return report.title === reportData.title;
                    } else if (report.type === 'aggregated' && reportData.type === 'aggregated') {
                        // 集約レポートの場合はタグで判定
                        return JSON.stringify(report.tags.sort()) === JSON.stringify(reportData.tags.sort());
                    }
                    return false;
                });
            };

            const removeFromFavorites = (reportId, event) => {
                setFavoriteReports(prev => {
                    const updatedReports = prev.filter(report => report.id !== reportId);

                    // ローカルストレージに保存
                    try {
                        localStorage.setItem('favoriteReports', JSON.stringify(updatedReports));
                    } catch (error) {
                        console.error('お気に入り削除保存エラー:', error);
                    }

                    return updatedReports;
                });

                // 削除時の完了アニメーション
                if (event) {
                    showCompletionAnimation(event.target, 'delete');
                }
            };

            // 作業完了感のあるアニメーション
            const showCompletionAnimation = (target, type) => {
                if (!target) return;
                
                // ボタンの一時的な変更
                const originalHTML = target.innerHTML;
                const originalClass = target.getAttribute('class') || target.className || '';
                
                // アニメーション状態に変更
                target.style.transform = 'scale(1.2)';
                target.style.transition = 'all 0.2s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
                
                if (type === 'success') {
                    target.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M20 6L9 17l-5-5"/>
                        </svg>
                    `;
                    target.setAttribute('class', String(originalClass).replace('text-gray-400', 'text-green-500'));
                } else if (type === 'existing') {
                    target.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                    `;
                    target.setAttribute('class', String(originalClass).replace('text-gray-400', 'text-orange-500'));
                } else if (type === 'delete') {
                    target.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M20 6L9 17l-5-5"/>
                        </svg>
                    `;
                    target.setAttribute('class', String(originalClass).replace('text-gray-400', 'text-red-500'));
                }
                
                // 波紋エフェクト
                const ripple = document.createElement('div');
                ripple.style.position = 'absolute';
                ripple.style.borderRadius = '50%';
                ripple.style.background = type === 'success' ? 'rgba(34, 197, 94, 0.3)' : 
                                         type === 'existing' ? 'rgba(249, 115, 22, 0.3)' : 
                                         'rgba(239, 68, 68, 0.3)';
                ripple.style.transform = 'scale(0)';
                ripple.style.animation = 'ripple 0.6s linear';
                ripple.style.width = '40px';
                ripple.style.height = '40px';
                ripple.style.left = '-12px';
                ripple.style.top = '-12px';
                ripple.style.pointerEvents = 'none';
                
                target.style.position = 'relative';
                target.appendChild(ripple);
                
                // アニメーション終了後に元に戻す
                setTimeout(() => {
                    target.style.transform = 'scale(1)';
                    setTimeout(() => {
                        target.innerHTML = originalHTML;
                        target.setAttribute('class', String(originalClass));
                        target.style.transform = '';
                        target.style.transition = '';
                        if (ripple.parentNode) {
                            ripple.parentNode.removeChild(ripple);
                        }
                    }, 200);
                }, 400);
            };

            // データ読み込み
            useEffect(() => {
                console.log('🎯 useEffect 実行開始');

                const initializeData = async () => {
                    try {
                        console.log('🚀 アプリケーション初期化開始');

                        // .env.localからAPIキーを読み込み
                        console.log('🔑 APIキー読み込み開始');
                        const loadedKey = await loadApiKeyFromEnv();
                        console.log('🔑 APIキー読み込み完了:', loadedKey ? loadedKey.substring(0, 10) + '...' : 'null');
                        console.log('🔑 グローバル GEMINI_API_KEY 確認:', GEMINI_API_KEY ? GEMINI_API_KEY.substring(0, 10) + '...' : 'null');

                        await loadData();

                        console.log('✅ データを使用');
                        console.log('記事数:', inlineData.articles.length);
                    } catch (error) {
                        console.error('❌ 初期化エラー:', error);
                        // エラーが発生してもAPIキーの読み込みは試行
                        if (!GEMINI_API_KEY) {
                            console.log('🔄 エラー後のAPIキー読み込み再試行');
                            await loadApiKeyFromEnv();
                        }
                    }
                    
                    // 記事に話題性スコアと静的サイズを追加
                    const articlesWithTopicality = inlineData.articles.map(article => {
                        const topicalityScore = calculateTopicalityScore(article);
                        const staticGridSize = getStaticGridSize(topicalityScore);
                        return {
                            ...article,
                            topicalityScore,
                            staticGridSize
                        };
                    });
                    
                    console.log('話題性スコア付き記事:', articlesWithTopicality.map(a => ({ 
                        title: a.title, 
                        score: a.topicalityScore,
                        size: a.staticGridSize
                    })));
                    
                    setArticles(articlesWithTopicality);
                    setHierarchicalTags(inlineData.hierarchical_tags);
                    
                    // 初期タグとリンクを設定
                    const { defaultTags, defaultLinks } = initializeDefaultTags();
                    setCollectedTags(defaultTags);
                    setTagLinks(defaultLinks);
                    
                    setDataLoaded(true);
                };
                
                initializeData();
            }, []);

            const handleArticleRead = (article, event) => {
                console.log('handleArticleRead実行:', { article, showFavorites, currentView });
                // 現在の画面状態を保存
                if (showFavorites) {
                    setPreviousView('favorites');
                } else if (currentView === 'favorites') {
                    setPreviousView('favoritesList');
                } else {
                    setPreviousView('main');
                }

                // 記事詳細表示
                console.log('記事詳細表示設定中...');
                setSelectedArticle(article);
                setShowArticleDetail(true);
                console.log('記事詳細表示設定完了');

                // パーティクルアニメーション開始
                const rect = event.target.getBoundingClientRect();
                const startX = rect.left + rect.width / 2;
                const startY = rect.top + rect.height / 2;
                
                if (window.startParticleEffect) {
                    window.startParticleEffect(startX, startY, article.tags);
                }

                // タグを収集
                const newTags = new Map(collectedTags);
                const newLinks = [...tagLinks];

                article.tags.forEach(tagId => {
                    if (newTags.has(tagId)) {
                        const existingTag = newTags.get(tagId);
                        existingTag.count++;
                        existingTag.size = 1 + existingTag.count * 0.3;
                        newTags.set(tagId, existingTag);
                    } else {
                        newTags.set(tagId, {
                            id: tagId,
                            count: 1,
                            size: 1,
                            x: Math.random() * 800 + 100,
                            y: Math.random() * 400 + 100
                        });
                    }
                });

                // タグ間のリンクを生成
                for (let i = 0; i < article.tags.length; i++) {
                    for (let j = i + 1; j < article.tags.length; j++) {
                        const sourceTag = article.tags[i];
                        const targetTag = article.tags[j];
                        
                        const linkExists = newLinks.some(link =>
                            (link.source === sourceTag && link.target === targetTag) ||
                            (link.source === targetTag && link.target === sourceTag)
                        );

                        if (!linkExists) {
                            newLinks.push({ source: sourceTag, target: targetTag });
                        }
                    }
                }

                setCollectedTags(newTags);
                setTagLinks(newLinks);
            };

            const handleTagClick = (tagId) => {
                // タグ選択の切り替え
                setSelectedTags(prev => {
                    if (prev.includes(tagId)) {
                        return prev.filter(id => id !== tagId);
                    } else {
                        return [...prev, tagId];
                    }
                });
            };

            const handleTagExpand = (tagId) => {
                const children = hierarchicalTags[tagId];
                if (!children) return;

                const newTags = new Map(collectedTags);
                const newLinks = [...tagLinks];
                
                if (newTags.has(tagId)) {
                    const parentTag = newTags.get(tagId);
                    parentTag.isExpanded = true;
                    newTags.set(tagId, parentTag);
                }

                children.forEach(childTag => {
                    if (!newTags.has(childTag)) {
                        newTags.set(childTag, {
                            id: childTag,
                            count: 1,
                            size: 0.7,
                            x: Math.random() * 800 + 100,
                            y: Math.random() * 400 + 100,
                            parent: tagId,
                            isChild: true
                        });

                        newLinks.push({ source: tagId, target: childTag });
                    }
                });

                setCollectedTags(newTags);
                setTagLinks(newLinks);
            };

            // グラデーション色を取得する関数
            const getGradientColor = (depth) => {
                // バランスバーと同じグラデーション: ピンク -> 青 -> 水色 -> 緑
                if (depth <= 33) {
                    // ピンクから青へ (0-33%)
                    const ratio = depth / 33;
                    const r = Math.round(236 + (59 - 236) * ratio);  // #ec4899 -> #3b82f6
                    const g = Math.round(72 + (130 - 72) * ratio);
                    const b = Math.round(153 + (246 - 153) * ratio);
                    return `rgb(${r}, ${g}, ${b})`;
                } else if (depth <= 66) {
                    // 青から水色へ (33-66%)
                    const ratio = (depth - 33) / 33;
                    const r = Math.round(59 + (6 - 59) * ratio);     // #3b82f6 -> #06b6d4
                    const g = Math.round(130 + (182 - 130) * ratio);
                    const b = Math.round(246 + (212 - 246) * ratio);
                    return `rgb(${r}, ${g}, ${b})`;
                } else {
                    // 水色から緑へ (66-100%)
                    const ratio = (depth - 66) / 34;
                    const r = Math.round(6 + (16 - 6) * ratio);      // #06b6d4 -> #10b981
                    const g = Math.round(182 + (185 - 182) * ratio);
                    const b = Math.round(212 + (129 - 212) * ratio);
                    return `rgb(${r}, ${g}, ${b})`;
                }
            };
            

            // マップ画面用：選択されたタグに関連する記事をフィルタリング
            const getMapFilteredArticles = () => {
                let baseArticles = articles;
                
                if (selectedTags.length > 0) {
                    const mainSelectedTag = selectedTags[0];
                    
                    // 1. 選択タグに直接関連する記事を取得
                    const directMatches = baseArticles.filter(article =>
                        article.tags.includes(mainSelectedTag)
                    );
                    
                    // 2. 選択タグのコンテキスト（私的/公的）に基づいて記事をフィルタリング
                    const contextualTags = getContextualTags(mainSelectedTag, 50);
                    const contextualMatches = baseArticles.filter(article =>
                        article.tags.some(tag => contextualTags.includes(tag))
                    );
                    
                    // 3. 全記事を追加（フィードビューが削除されたため）
                    const additionalArticles = baseArticles;
                    
                    // 4. 重複を除いて優先順位でソート
                    const allArticles = [...directMatches, ...contextualMatches, ...additionalArticles];
                    const uniqueArticles = Array.from(
                        new Map(allArticles.map(article => [article.title, article])).values()
                    );
                    
                    // 5. 関連度でソート
                    uniqueArticles.sort((a, b) => {
                        const aDirectMatch = a.tags.includes(mainSelectedTag) ? 3 : 0;
                        const aContextMatch = a.tags.some(tag => contextualTags.includes(tag)) ? 2 : 0;
                        const aTagCount = a.tags.filter(tag => selectedTags.includes(tag)).length;
                        
                        const bDirectMatch = b.tags.includes(mainSelectedTag) ? 3 : 0;
                        const bContextMatch = b.tags.some(tag => contextualTags.includes(tag)) ? 2 : 0;
                        const bTagCount = b.tags.filter(tag => selectedTags.includes(tag)).length;
                        
                        const aScore = aDirectMatch + aContextMatch + aTagCount;
                        const bScore = bDirectMatch + bContextMatch + bTagCount;
                        
                        return bScore - aScore;
                    });
                    
                    return uniqueArticles;
                } else {
                    // 選択タグなしの場合は全記事表示
                    return articles;
                }
            };

            const tagsArray = Array.from(collectedTags.values());
            
            // マップビュー専用のため、全記事を表示
            const filteredArticles = articles;

            // D3.jsマップの初期化とアップデート
            useEffect(() => {
                if (currentView !== 'map' || tagsArray.length === 0) return;

                const container = document.getElementById('map-container');
                const svg = d3.select("#mapSvg");
                
                if (!container || !svg.node()) return;

                const width = container.clientWidth;
                const height = container.clientHeight;

                // 既存の要素をクリア
                svg.selectAll("*").remove();

                // 背景の透明な矩形を追加（クリック領域として）
                const background = svg.append("rect")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("fill", "transparent")
                    .style("cursor", "pointer");

                // グループの作成
                const linkGroup = svg.append("g").attr("class", "links");
                const nodeGroup = svg.append("g").attr("class", "nodes");
                const textGroup = svg.append("g").attr("class", "texts");

                // シミュレーションのセットアップ（安定化）
                const simulation = d3.forceSimulation(tagsArray)
                    .force("link", d3.forceLink(tagLinks)
                        .id(d => d.id)
                        .distance(80)
                        .strength(0.3))
                    .force("charge", d3.forceManyBody()
                        .strength(-150)
                        .distanceMin(30)
                        .distanceMax(200))
                    .force("center", d3.forceCenter(width / 2, height / 2)
                        .strength(0.05))
                    .force("collision", d3.forceCollide()
                        .radius(d => 25 + d.size * 5)
                        .strength(0.7))
                    .alphaDecay(0.02)
                    .velocityDecay(0.3);

                // リンクの描画
                const links = linkGroup
                    .selectAll("line")
                    .data(tagLinks)
                    .enter()
                    .append("line")
                    .style("stroke", "rgba(255, 255, 255, 0.2)")
                    .style("stroke-width", 2);

                // ノードの描画
                const nodes = nodeGroup
                    .selectAll("circle")
                    .data(tagsArray)
                    .enter()
                    .append("circle")
                    .attr("r", d => 15 + d.size * 8)
                    .style("fill", d => {
                        if (d.isChild) {
                            // 子タグは少し暗めに
                            const baseColor = getGradientColor(interestDepth);
                            const rgb = baseColor.match(/\d+/g);
                            const r = Math.max(0, parseInt(rgb[0]) - 30);
                            const g = Math.max(0, parseInt(rgb[1]) - 30);
                            const b = Math.max(0, parseInt(rgb[2]) - 30);
                            return `rgb(${r}, ${g}, ${b})`;
                        }
                        return getGradientColor(interestDepth);
                    })
                    .style("stroke", "rgba(255, 255, 255, 0.8)")
                    .style("stroke-width", 2)
                    .style("cursor", "pointer")
                    .style("filter", "drop-shadow(0 4px 8px rgba(0,0,0,0.3))")
                    .style("stroke-width", d => selectedTags.includes(d.id) ? 4 : 2)
                    .style("stroke", d => selectedTags.includes(d.id) ? "#fbbf24" : "rgba(255, 255, 255, 0.8)")
                    .on("click", (event, d) => {
                        event.stopPropagation();
                        if (event.shiftKey) {
                            // Shiftクリックで選択のみ
                            handleTagClick(d.id);
                        } else {
                            // 通常クリックで展開
                            const children = hierarchicalTags[d.id];
                            if (children && !d.isExpanded) {
                                handleTagExpand(d.id);
                            } else {
                                // 展開済みまたは子タグがない場合は選択
                                handleTagClick(d.id);
                            }
                        }
                    })
                    .on("mouseover", function(event, d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr("r", (15 + d.size * 8) * 1.2)
                            .style("filter", "drop-shadow(0 6px 12px rgba(0,0,0,0.4))");
                    })
                    .on("mouseout", function(event, d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr("r", 15 + d.size * 8)
                            .style("filter", "drop-shadow(0 4px 8px rgba(0,0,0,0.3))");
                    });

                // テキストラベルの描画
                const texts = textGroup
                    .selectAll("text")
                    .data(tagsArray)
                    .enter()
                    .append("text")
                    .text(d => d.id)
                    .style("fill", "white")
                    .style("font-size", d => `${12 + d.size * 2}px`)
                    .style("font-weight", "600")
                    .style("text-anchor", "middle")
                    .style("dominant-baseline", "central")
                    .style("pointer-events", "none")
                    .style("text-shadow", "1px 1px 2px rgba(0,0,0,0.8)");

                // ドラッグ処理（滑らかに）
                const drag = d3.drag()
                    .on("start", (event, d) => {
                        if (!event.active) simulation.alphaTarget(0.1).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                        // ドラッグ中は速度を制限
                        d.vx = d.vx * 0.1;
                        d.vy = d.vy * 0.1;
                    })
                    .on("drag", (event, d) => {
                        d.fx = event.x;
                        d.fy = event.y;
                    })
                    .on("end", (event, d) => {
                        if (!event.active) simulation.alphaTarget(0.05);
                        // ドラッグ終了後も位置を保持しない
                        setTimeout(() => {
                            d.fx = null;
                            d.fy = null;
                        }, 500);
                    });

                nodes.call(drag);

                // ズーム処理
                const zoom = d3.zoom()
                    .scaleExtent([0.5, 3])
                    .filter((event) => {
                        // 背景矩形のクリックは通す、他のズーム操作は制限
                        return !event.button && (event.type !== 'click');
                    })
                    .on("zoom", (event) => {
                        linkGroup.attr("transform", event.transform);
                        nodeGroup.attr("transform", event.transform);
                        textGroup.attr("transform", event.transform);
                    });

                svg.call(zoom);
                
                // ノードを中央にリセットする関数
                const resetNodesPosition = () => {
                    console.log("リセット開始");
                    
                    // 1. 固定位置と速度をクリア
                    tagsArray.forEach(d => {
                        d.fx = null;
                        d.fy = null;
                        d.vx = 0;
                        d.vy = 0;
                        // 中央付近にコンパクトに配置
                        d.x = width/2 + (Math.random() - 0.5) * 60;
                        d.y = height/2 + (Math.random() - 0.5) * 60;
                    });
                    
                    // 2. ズームリセット
                    svg.call(zoom.transform, d3.zoomIdentity);
                    
                    // 3. シミュレーションを穏やかに再開
                    simulation
                        .alpha(0.2)
                        .alphaTarget(0.05)
                        .restart();
                    
                    console.log("リセット完了");
                };
                
                // 背景矩形のクリックでリセット
                background.on("click", (event) => {
                    console.log("背景クリック検知!", event);
                    resetNodesPosition();
                });
                
                // SVGのデフォルトズーム動作を無効化
                svg.on("dblclick.zoom", null);

                // シミュレーションの更新
                simulation.on("tick", () => {
                    links
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    nodes
                        .attr("cx", d => d.x)
                        .attr("cy", d => d.y);

                    texts
                        .attr("x", d => d.x)
                        .attr("y", d => d.y);
                });

            }, [currentView, tagsArray, tagLinks, interestDepth]);

            // selectedTagsが変更された時だけノードのスタイルを更新
            useEffect(() => {
                if (currentView !== 'map') return;

                const svg = d3.select("#mapSvg");
                if (!svg.node()) return;

                // ノードのスタイルのみ更新
                svg.selectAll("circle")
                    .style("stroke-width", d => selectedTags.includes(d.id) ? 4 : 2)
                    .style("stroke", d => selectedTags.includes(d.id) ? "#fbbf24" : "rgba(255, 255, 255, 0.8)");

                // テキストのスタイルのみ更新
                svg.selectAll("text")
                    .style("fill", d => selectedTags.includes(d.id) ? "#fbbf24" : "white")
                    .style("font-weight", d => selectedTags.includes(d.id) ? "700" : "600");

            }, [selectedTags, currentView]);
            
            // 選択ノードに関連するコンテキストタグを取得
            const getContextualTags = (selectedTag, interestLevel) => {
                const tagContexts = {
                    '旅行': {
                        private: ['料理', '温泉', 'グルメ', 'リゾート', 'フォト', '休日'],
                        professional: ['出張', '会議', 'ビジネスホテル', 'ネットワーキング', '文化交流'],
                        balanced: ['料理', '文化', '歴史', '交通', 'ホテル']
                    },
                    '料理': {
                        private: ['手料理', 'スイーツ', '家庭料理', 'レシピ', 'おやつ'],
                        professional: ['レストラン', 'フードビジネス', '栄養学', 'フードテック'],
                        balanced: ['和食', '寿司', 'グルメ', '旅行', '文化']
                    },
                    'AI': {
                        private: ['チャットボット', 'ゲーム', 'アプリ', '音声アシスタント'],
                        professional: ['機械学習', '技術', 'ビジネス', 'データ分析', '自動化'],
                        balanced: ['技術', 'イノベーション', '未来', '社会']
                    },
                    '動物': {
                        private: ['ペット', '猫', '犬', 'アニマルカフェ', '動物園'],
                        professional: ['獣医学', '生態学', '絶滅保護', 'SDGs', '環境'],
                        balanced: ['ペット', '自然', '環境', '保護']
                    }
                };
                
                const context = tagContexts[selectedTag];
                if (!context) return [];
                
                if (interestLevel < 30) return context.private || [];
                if (interestLevel > 70) return context.professional || [];
                return context.balanced || [];
            };
            
            // 興味の深さに応じた動的タグ生成
            const generateDynamicTags = (depth) => {
                if (depth <= 30) {
                    // 私的興味：具体的で個人的なタグ
                    return [
                        { id: '北海道', size: 1.2, x: 180, y: 120, category: 'private' },
                        { id: '沖縄', size: 1.1, x: 320, y: 100, category: 'private' },
                        { id: '温泉', size: 1.0, x: 460, y: 130, category: 'private' },
                        { id: '家庭料理', size: 1.0, x: 200, y: 280, category: 'private' },
                        { id: 'ペット', size: 1.0, x: 380, y: 320, category: 'private' },
                        { id: '猫', size: 0.9, x: 520, y: 260, category: 'private' },
                        { id: 'アニメ', size: 0.8, x: 150, y: 350, category: 'private' },
                        { id: 'ゲーム', size: 0.8, x: 580, y: 180, category: 'private' }
                    ];
                } else if (depth <= 70) {
                    // バランス：一般的なタグ
                    return [
                        { id: 'AI', size: 1.2, x: 180, y: 120, category: 'balanced' },
                        { id: '技術', size: 1.1, x: 320, y: 100, category: 'balanced' },
                        { id: 'ビジネス', size: 1.0, x: 460, y: 130, category: 'balanced' },
                        { id: '料理', size: 1.0, x: 200, y: 280, category: 'balanced' },
                        { id: '旅行', size: 1.0, x: 380, y: 320, category: 'balanced' },
                        { id: '動物', size: 0.9, x: 520, y: 260, category: 'balanced' },
                        { id: 'ファッション', size: 0.8, x: 150, y: 350, category: 'balanced' },
                        { id: 'SDGs', size: 0.8, x: 580, y: 180, category: 'balanced' }
                    ];
                } else {
                    // パーソナル：ビジネス・専門的なタグ
                    return [
                        { id: '機械学習', size: 1.2, x: 180, y: 120, category: 'professional' },
                        { id: 'スタートアップ', size: 1.1, x: 320, y: 100, category: 'professional' },
                        { id: 'マーケティング', size: 1.0, x: 460, y: 130, category: 'professional' },
                        { id: 'フードテック', size: 1.0, x: 200, y: 280, category: 'professional' },
                        { id: '海外旅行', size: 1.0, x: 380, y: 320, category: 'professional' },
                        { id: 'ツアー', size: 0.9, x: 520, y: 260, category: 'professional' },
                        { id: 'Eコマース', size: 0.8, x: 150, y: 350, category: 'professional' },
                        { id: 'データ分析', size: 0.8, x: 580, y: 180, category: 'professional' }
                    ];
                }
            };

            // マップ用のタグセットを初期化
            useEffect(() => {
                if (currentView === 'map') {
                    const currentTags = generateDynamicTags(interestDepth);
                    
                    // タグマップを作成
                    const updatedTags = new Map();
                    currentTags.forEach(tag => {
                        const existingTag = collectedTags.get(tag.id);
                        updatedTags.set(tag.id, {
                            id: tag.id,
                            count: existingTag ? existingTag.count : 1,
                            size: tag.size,
                            x: existingTag ? existingTag.x : tag.x,
                            y: existingTag ? existingTag.y : tag.y,
                            category: tag.category,
                            fx: existingTag ? existingTag.fx : null,
                            fy: existingTag ? existingTag.fy : null
                        });
                    });
                    
                    // 動的リンク関係を作成
                    let updatedLinks = [];
                    if (interestDepth <= 30) {
                        // 私的興味のリンク
                        updatedLinks = [
                            { source: '北海道', target: '温泉' },
                            { source: '沖縄', target: '温泉' },
                            { source: '家庭料理', target: 'ペット' },
                            { source: '猫', target: 'ペット' },
                            { source: 'アニメ', target: 'ゲーム' }
                        ];
                    } else if (interestDepth <= 70) {
                        // バランスのリンク
                        updatedLinks = [
                            { source: 'AI', target: '技術' },
                            { source: '技術', target: 'ビジネス' },
                            { source: '料理', target: '旅行' },
                            { source: '動物', target: 'ファッション' },
                            { source: 'ビジネス', target: 'SDGs' }
                        ];
                    } else {
                        // パーソナル・専門的なリンク
                        updatedLinks = [
                            { source: '機械学習', target: 'データ分析' },
                            { source: 'スタートアップ', target: 'マーケティング' },
                            { source: 'フードテック', target: 'Eコマース' },
                            { source: '海外旅行', target: 'ツアー' },
                            { source: 'マーケティング', target: 'データ分析' }
                        ];
                    }
                    
                    setCollectedTags(updatedTags);
                    setTagLinks(updatedLinks);
                }
            }, [currentView, interestDepth]);

            // データ読み込み中の表示
            if (!dataLoaded) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-gray-600">データを読み込んでいます...</p>
                        </div>
                    </div>
                );
            }

            // 現在のビューに応じてコンポーネントを表示
            if (currentView === 'favorites') {
                return (
                    <div className="min-h-screen bg-gray-50">
                        <ParticleSystem />

                        {/* 記事詳細モーダル */}
                        {showArticleDetail && selectedArticle && (
                            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                                <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
                                    {/* 固定ヘッダー（閉じるボタンのみ） */}
                                    <div className="absolute top-0 left-0 right-0 z-10 p-4 flex justify-end">
                                        <button
                                            onClick={() => {
                                                setShowArticleDetail(false);
                                                // 前の画面に戻る
                                                if (previousView === 'favorites') {
                                                    setShowFavorites(true);
                                                } else if (previousView === 'favoritesList') {
                                                    // お気に入りリスト画面にはそのまま残る
                                                } else {
                                                    setCurrentView('map');
                                                }
                                            }}
                                            className="w-10 h-10 bg-black/20 hover:bg-black/40 rounded-full flex items-center justify-center text-white transition-all"
                                        >
                                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M15 5L5 15M5 5l10 10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                            </svg>
                                        </button>
                                    </div>

                                    {/* スクロール可能なコンテンツ */}
                                    <div className="overflow-y-auto max-h-[90vh]">
                                        {/* 記事画像 */}
                                        <div className="relative">
                                            <div className="h-48 bg-gradient-to-br from-blue-500 to-purple-600 relative overflow-hidden">
                                                <img
                                                    src="https://s.yimg.jp/images/ksk/tool/img/photo01.png"
                                                    alt={selectedArticle.title}
                                                    className="w-full h-full object-cover opacity-80"
                                                />
                                                <div className="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent"></div>

                                                {/* 話題度バッジ */}
                                                <div className={`absolute top-4 left-4 px-3 py-1 rounded-full text-white text-sm font-medium ${
                                                    (selectedArticle.topicalityScore || 50) >= 80 ? 'bg-red-500' :
                                                    (selectedArticle.topicalityScore || 50) >= 60 ? 'bg-orange-500' :
                                                    (selectedArticle.topicalityScore || 50) >= 40 ? 'bg-yellow-500' : 'bg-gray-500'
                                                }`}>
                                                    話題度 {Math.round(selectedArticle.topicalityScore || 50)}
                                                </div>
                                            </div>
                                        </div>

                                        {/* コンテンツ */}
                                        <div className="p-6">
                                            {/* タイトル */}
                                            <h1 className={`text-2xl font-bold font-${selectedFont} text-gray-900 mb-4 leading-tight`}>
                                                {selectedArticle.title}
                                            </h1>

                                            {/* メタ情報 */}
                                            <div className="flex items-center gap-4 mb-6 text-sm text-gray-500">
                                                <span className="flex items-center gap-2">
                                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M8 0C3.6 0 0 3.6 0 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm0 14c-3.3 0-6-2.7-6-6s2.7-6 6-6 6 2.7 6 6-2.7 6-6 6zm1-10H7v5l4 2.4.8-1.2-3.8-2.2V4z" fill="currentColor"/>
                                                    </svg>
                                                    {new Date().toLocaleDateString('ja-JP')}
                                                </span>
                                                <span className="flex items-center gap-2">
                                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M2 4.5C2 3.67157 2.67157 3 3.5 3H12.5C13.3284 3 14 3.67157 14 4.5V11.5C14 12.3284 13.3284 13 12.5 13H3.5C2.67157 13 2 12.3284 2 11.5V4.5ZM3.5 4C3.22386 4 3 4.22386 3 4.5V5.5L8 8.5L13 5.5V4.5C13 4.22386 12.7761 4 12.5 4H3.5ZM13 6.5L8 9.5L3 6.5V11.5C3 11.7761 3.22386 12 3.5 12H12.5C12.7761 12 13 11.7761 13 11.5V6.5Z" fill="currentColor"/>
                                                    </svg>
                                                    {selectedArticle.source}
                                                </span>
                                            </div>

                                            {/* 記事本文 */}
                                            <div className="prose max-w-none mb-6">
                                                <p className={`text-gray-700 leading-relaxed text-base mb-4 font-${selectedFont}`}>
                                                    {selectedArticle.snippet}
                                                </p>

                                                {/* 詳細内容（サンプル） */}
                                                <p className={`text-gray-700 leading-relaxed text-base mb-4 font-${selectedFont}`}>
                                                    この記事では、{selectedArticle.title}について詳しく解説します。最新の動向や技術的な詳細、今後の展望についても触れながら、読者の皆様にとって有益な情報をお届けします。
                                                </p>

                                                <p className={`text-gray-700 leading-relaxed text-base mb-4 font-${selectedFont}`}>
                                                    {(selectedArticle.tags || []).includes('AI') && 'AI技術の進歩により、私たちの生活は大きく変化しています。'}
                                                    {(selectedArticle.tags || []).includes('技術') && 'この技術革新は、産業界全体に影響を与えています。'}
                                                    {(selectedArticle.tags || []).includes('ビジネス') && 'ビジネスの世界では、新しいビジネスモデルが次々と生まれています。'}
                                                    {(selectedArticle.tags || []).includes('料理') && '食文化の多様性と伝統の継承について考える機会となります。'}
                                                    今後の動向にも注目していく必要があります。
                                                </p>
                                            </div>

                                            {/* タグ */}
                                            <div className="mb-6">
                                                <h3 className={`text-base font-${selectedFont} text-gray-600 mb-3`}>関連タグ</h3>
                                                <div className="flex flex-wrap gap-2">
                                                    {(selectedArticle.tags || []).map((tag, index) => (
                                                        <span
                                                            key={index}
                                                            className="px-3 py-1.5 bg-blue-100 text-blue-700 text-sm rounded-full font-medium hover:bg-blue-200 transition-colors cursor-pointer"
                                                            onClick={() => {
                                                                handleTagClick(tag);
                                                                setShowArticleDetail(false);
                                                                setCurrentView('map');
                                                            }}
                                                        >
                                                            #{tag}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* アクションボタン */}
                                            <div className="flex justify-center pt-4 border-t">
                                                <button
                                                    onClick={() => setShowArticleDetail(false)}
                                                    className="px-6 py-3 border border-gray-300 hover:border-gray-400 text-gray-700 rounded-lg font-medium transition-colors"
                                                >
                                                    閉じる
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* ヘッダー */}
                        <header className="bg-white shadow-sm border-b relative">
                            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                                <div className="flex items-center justify-center h-16 relative">
                                    <h1 className={`text-xl font-${selectedFont} text-gray-900`}>お気に入り集約</h1>
                                    <div className="absolute right-0 flex items-center gap-2">
                                        {/* フォント設定ボタン */}
                                        <button
                                            onClick={() => setShowFontSelector(!showFontSelector)}
                                            className="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center text-gray-600 transition-colors"
                                            title="フォント設定"
                                        >
                                            <svg width="16" height="16" viewBox="0 0 22 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M8.25001 20L7.85001 16.8C7.63335 16.7167 7.42918 16.6167 7.23751 16.5C7.04585 16.3833 6.85835 16.2583 6.67501 16.125L3.70001 17.375L0.950012 12.625L3.52501 10.675C3.50835 10.5583 3.50001 10.4458 3.50001 10.3375V9.6625C3.50001 9.55417 3.50835 9.44167 3.52501 9.325L0.950012 7.375L3.70001 2.625L6.67501 3.875C6.85835 3.74167 7.05001 3.61667 7.25001 3.5C7.45001 3.38333 7.65001 3.28333 7.85001 3.2L8.25001 0H13.75L14.15 3.2C14.3667 3.28333 14.5708 3.38333 14.7625 3.5C14.9542 3.61667 15.1417 3.74167 15.325 3.875L18.3 2.625L21.05 7.375L18.475 9.325C18.4917 9.44167 18.5 9.55417 18.5 9.6625V10.3375C18.5 10.4458 18.4833 10.5583 18.45 10.675L21.025 12.625L18.275 17.375L15.325 16.125C15.1417 16.2583 14.95 16.3833 14.75 16.5C14.55 16.6167 14.35 16.7167 14.15 16.8L13.75 20H8.25001ZM11.05 13.5C12.0167 13.5 12.8417 13.1583 13.525 12.475C14.2083 11.7917 14.55 10.9667 14.55 10C14.55 9.03333 14.2083 8.20833 13.525 7.525C12.8417 6.84167 12.0167 6.5 11.05 6.5C10.0667 6.5 9.23751 6.84167 8.56251 7.525C7.88751 8.20833 7.55001 9.03333 7.55001 10C7.55001 10.9667 7.88751 11.7917 8.56251 12.475C9.23751 13.1583 10.0667 13.5 11.05 13.5Z" fill="currentColor"/>
                                            </svg>
                                        </button>
                                        {/* AIヘルプボタン */}
                                        <button
                                            onClick={() => setShowAiHelp(!showAiHelp)}
                                            className={`w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center text-sm font-${selectedFont} text-gray-600 transition-colors`}
                                            title="AI要約について"
                                        >
                                            i
                                        </button>
                                    </div>
                                </div>

                                {/* AIヘルプポップアップ */}
                                {showAiHelp && (
                                    <div className="absolute top-full right-4 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg p-4 w-80 z-30">
                                        <div className="flex justify-between items-start mb-3">
                                            <h4 className="font-handwriting text-gray-900">AI要約機能について</h4>
                                            <button
                                                onClick={() => setShowAiHelp(false)}
                                                className="text-gray-400 hover:text-gray-600 ml-2"
                                            >
                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M12 4L4 12M4 4l8 8" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                                                </svg>
                                            </button>
                                        </div>
                                        <div className={`text-sm text-gray-600 font-${selectedFont} space-y-2`}>
                                            <p>各レポートには要約機能があります：</p>
                                            <ul className="list-disc pl-4 space-y-1">
                                                <li>レポートを開くと、関連記事の要約が自動生成されます</li>
                                                <li>複数の記事から主要なポイントを抽出します</li>
                                                <li>効率的に情報を把握できます</li>
                                            </ul>
                                        </div>
                                    </div>
                                )}

                                {/* フォント選択パネル */}
                                {showFontSelector && (
                                    <div className="absolute top-full right-4 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg p-4 w-80 z-30">
                                        <div className="flex justify-between items-start mb-3">
                                            <h4 className={`font-${selectedFont} text-gray-900`}>フォント選択</h4>
                                            <button
                                                onClick={() => setShowFontSelector(false)}
                                                className="text-gray-400 hover:text-gray-600"
                                            >
                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M12 4L4 12M4 4l8 8" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                                                </svg>
                                            </button>
                                        </div>
                                        <div className="space-y-2">
                                            {fontOptions.map(font => (
                                                <button
                                                    key={font.id}
                                                    onClick={() => changeFont(font.id)}
                                                    className={`w-full p-3 text-left rounded-lg border transition-colors ${
                                                        selectedFont === font.id
                                                            ? 'border-blue-500 bg-blue-50'
                                                            : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                                                    }`}
                                                >
                                                    <div className={`font-${font.id} text-gray-900 mb-1`}>
                                                        {font.name}
                                                    </div>
                                                    <div className={`font-${font.id} text-sm text-gray-600`}>
                                                        {font.sample}
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </header>

                        {/* コンテンツ */}
                        <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            {/* 集約レポート セクション */}
                            <div className="mb-8">
                                <h2 className={`text-xl font-${selectedFont} text-gray-900 mb-6`}>レポート</h2>
                                {console.log('📋 お気に入り表示チェック:', favoriteReports)}
                                {favoriteReports.filter(report => report.type === 'aggregated').length === 0 ? (
                                <div className="text-center py-12">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" className="mx-auto mb-4 text-gray-300">
                                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                                    </svg>
                                    <h3 className={`text-lg font-${selectedFont} text-gray-900 mb-2`}>お気に入りレポートがありません</h3>
                                    <p className={`text-gray-500 font-${selectedFont}`}>レポートのピンアイコンをクリックして追加できます</p>
                                </div>
                            ) : (
                                    <div className="space-y-3">
                                    {favoriteReports.filter(report => report.type === 'aggregated').map((report, index) => (
                                        <div
                                            key={report.id || index}
                                            className="bg-white rounded-xl border border-gray-200 p-3 hover:shadow-md hover:border-blue-200 transition-all cursor-pointer"
                                            onClick={() => {
                                                // レポートを再現してメインページに戻る
                                                console.log('📂 お気に入りレポートを開く：分析結果をリセット');
                                                setShowAnalysisResults(false);
                                                setGeneratedReport(null);
                                                setSelectedKeywordDetail(null);
                                                setSelectedTags(report.tags || []);
                                                setPreviousView('favoritesList'); // お気に入りリストから来たことを記録
                                                setShowFavorites(true);
                                                setCurrentView('map');
                                            }}
                                        >
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center flex-1">
                                                        <span className={`text-sm font-${selectedFont} text-gray-900`}>
                                                            {(report.tags || []).join(' × ') || '無題のレポート'}
                                                        </span>
                                                    </div>
                                                    <div className="flex items-center space-x-2 ml-4">
                                                        {/* 時計アイコン */}
                                                        <button
                                                            className="p-1 text-gray-400 hover:text-gray-600 transition-colors"
                                                            title="タイマー"
                                                        >
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                                <circle cx="12" cy="12" r="10"/>
                                                                <polyline points="12,6 12,12 16,14"/>
                                                            </svg>
                                                        </button>
                                                        {/* ゴミ箱アイコン */}
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                removeFromFavorites(report.id, e);
                                                            }}
                                                            className="p-1 text-gray-400 hover:text-red-500 transition-colors"
                                                            title="削除"
                                                        >
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                                <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            </div>

                            {/* 記事セクション */}
                            <div>
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className={`text-xl font-${selectedFont} text-gray-900`}>お気に入り記事</h2>
                                    <div className="flex bg-gray-100 rounded-lg p-1 shadow-sm">
                                        <button
                                            onClick={() => setFavoritesViewMode('grid')}
                                            className={`p-1.5 rounded transition-all ${
                                                favoritesViewMode === 'grid'
                                                ? 'bg-white text-gray-900 shadow-sm'
                                                : 'text-gray-500 hover:text-gray-700'
                                            }`}
                                        >
                                            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="1" y="1" width="5" height="5" rx="1" fill="currentColor"/>
                                                <rect x="8" y="1" width="5" height="5" rx="1" fill="currentColor"/>
                                                <rect x="1" y="8" width="5" height="5" rx="1" fill="currentColor"/>
                                                <rect x="8" y="8" width="5" height="5" rx="1" fill="currentColor"/>
                                            </svg>
                                        </button>
                                        <button
                                            onClick={() => setFavoritesViewMode('list')}
                                            className={`p-1.5 rounded transition-all ${
                                                favoritesViewMode === 'list'
                                                ? 'bg-white text-gray-900 shadow-sm'
                                                : 'text-gray-500 hover:text-gray-700'
                                            }`}
                                        >
                                            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="1" y="2" width="12" height="1.5" rx="0.75" fill="currentColor"/>
                                                <rect x="1" y="6" width="12" height="1.5" rx="0.75" fill="currentColor"/>
                                                <rect x="1" y="10" width="12" height="1.5" rx="0.75" fill="currentColor"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                {/* 記事表示 */}
                                <div onClick={() => setLongPressedArticle(null)}>
                                {(() => {
                                    const favoriteArticles = favoriteReports.filter(report => report.type === 'article');
                                    console.log('お気に入り記事一覧:', favoriteArticles);

                                    if (favoritesViewMode === 'grid') {
                                        return (
                                            <div className="grid grid-cols-3 gap-2">
                                                {favoriteArticles.length === 0 ? (
                                                    <div className="col-span-3 text-center py-8 text-gray-500">
                                                        更新がありません
                                                    </div>
                                                ) : (
                                                    favoriteArticles.map((report, index) => (
                                                        <div
                                                            key={report.id || index}
                                                            className="aspect-square bg-white border border-gray-200 rounded cursor-pointer hover:shadow-md transition-shadow overflow-hidden relative"
                                                            onClick={(e) => {
                                                                // 長押し状態の時はクリックを無効にする
                                                                if (longPressedArticle === report.id) {
                                                                    return;
                                                                }
                                                                console.log('お気に入り記事クリック:', report);
                                                                const article = report.articleData || {
                                                                    title: report.title?.replace('記事: ', '') || '無題の記事',
                                                                    tags: report.tags || [],
                                                                    snippet: '記事の詳細',
                                                                    source: 'お気に入り'
                                                                };
                                                                console.log('記事データ:', article);
                                                                try {
                                                                    handleArticleRead(article, e);
                                                                } catch (error) {
                                                                    console.error('記事詳細表示エラー:', error);
                                                                }
                                                            }}
                                                            onTouchStart={(e) => {
                                                                const timer = handleLongPressStart(report.id);
                                                                e.target._longPressTimer = timer;
                                                            }}
                                                            onTouchEnd={(e) => {
                                                                if (e.target._longPressTimer) {
                                                                    handleLongPressEnd(e.target._longPressTimer);
                                                                }
                                                            }}
                                                            onMouseDown={(e) => {
                                                                const timer = handleLongPressStart(report.id);
                                                                e.target._longPressTimer = timer;
                                                            }}
                                                            onMouseUp={(e) => {
                                                                if (e.target._longPressTimer) {
                                                                    handleLongPressEnd(e.target._longPressTimer);
                                                                }
                                                            }}
                                                            onMouseLeave={(e) => {
                                                                if (e.target._longPressTimer) {
                                                                    handleLongPressEnd(e.target._longPressTimer);
                                                                }
                                                            }}
                                                        >
                                                            <div className="h-full flex flex-col p-2">
                                                                <div className="flex-1 flex items-center justify-center bg-gray-100 rounded mb-2">
                                                                    <img
                                                                        src="https://s.yimg.jp/images/ksk/tool/img/photo01.png"
                                                                        alt={report.articleData?.title || 'Article'}
                                                                        className="w-full h-full object-cover rounded"
                                                                    />
                                                                </div>
                                                                <div className={`text-xs text-gray-900 font-bold font-${selectedFont} line-clamp-2`}>
                                                                    {report.articleData?.title || report.title?.replace('記事: ', '')}
                                                                </div>
                                                            </div>

                                                            {/* 長押し時の削除ボタン */}
                                                            {longPressedArticle === report.id && (
                                                                <div className="absolute inset-0 bg-black bg-opacity-40">
                                                                    <button
                                                                        onClick={(e) => deleteArticleFromFavorites(report.id, e)}
                                                                        className="absolute top-1 right-1 w-6 h-6 bg-white rounded-full flex items-center justify-center text-gray-600 shadow-lg hover:bg-gray-100 transition-colors"
                                                                        title="削除"
                                                                    >
                                                                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                            <path d="M9 3L3 9M3 3l6 6" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                                                                        </svg>
                                                                    </button>
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))
                                                )}
                                            </div>
                                        );
                                    } else {
                                        // リストビュー
                                        return (
                                            <div className="space-y-3">
                                                {favoriteArticles.length === 0 ? (
                                                    <div className="text-center py-8 text-gray-500">
                                                        更新がありません
                                                    </div>
                                                ) : (
                                                    favoriteArticles.map((report, index) => (
                                                        <div
                                                            key={report.id || index}
                                                            className="bg-white rounded-lg p-3 shadow-sm border hover:shadow-md transition-all cursor-pointer relative"
                                                            onClick={(e) => {
                                                                console.log('お気に入り記事クリック:', report);
                                                                const article = report.articleData || {
                                                                    title: report.title?.replace('記事: ', '') || '無題の記事',
                                                                    tags: report.tags || [],
                                                                    snippet: '記事の詳細',
                                                                    source: 'お気に入り'
                                                                };
                                                                console.log('記事データ:', article);
                                                                try {
                                                                    handleArticleRead(article, e);
                                                                } catch (error) {
                                                                    console.error('記事詳細表示エラー:', error);
                                                                }
                                                            }}
                                                        >
                                                            <div className="flex gap-3">
                                                                <div className="w-16 h-16 bg-gray-100 rounded overflow-hidden flex-shrink-0">
                                                                    <img
                                                                        src="https://s.yimg.jp/images/ksk/tool/img/photo01.png"
                                                                        alt={report.articleData?.title || 'Article'}
                                                                        className="w-full h-full object-cover"
                                                                    />
                                                                </div>
                                                                <div className="flex-1 min-w-0">
                                                                    <h4 className={`text-sm font-bold font-${selectedFont} text-gray-900 line-clamp-2 mb-1`}>
                                                                        {report.articleData?.title || report.title?.replace('記事: ', '')}
                                                                    </h4>
                                                                    <p className={`text-xs text-gray-600 font-${selectedFont} line-clamp-2 mb-2`}>
                                                                        {report.articleData?.snippet || '記事の詳細'}
                                                                    </p>
                                                                    <div className="flex items-center justify-between text-xs text-gray-400">
                                                                        <span>{report.articleData?.source || 'ソース不明'}</span>
                                                                        <span>お気に入り</span>
                                                                    </div>
                                                                </div>

                                                            {/* リスト表示の削除ボタン（右上） */}
                                                            <button
                                                                onClick={(e) => deleteArticleFromFavorites(report.id, e)}
                                                                className="absolute -top-2 -right-2 w-6 h-6 bg-white rounded-full flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-50 shadow-sm transition-colors border"
                                                                title="削除"
                                                            >
                                                                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                    <path d="M9 3L3 9M3 3l6 6" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                                                                </svg>
                                                            </button>
                                                            </div>
                                                        </div>
                                                    ))
                                                )}
                                            </div>
                                        );
                                    }
                                })()}
                                </div>
                            </div>
                        </main>

                        {/* 下部ナビゲーション */}
                        <nav className="fixed bottom-0 left-0 right-0 bg-white/20 backdrop-blur-sm border-t border-gray-200/30 shadow-lg z-50">
                            <div className="flex items-center justify-between px-4 py-2">
                                {/* 左寄せ: ホームボタン */}
                                <button
                                    onClick={() => setCurrentView('map')}
                                    className="w-10 h-10 rounded-full flex items-center justify-center transition-all bg-gray-100 text-gray-600 hover:bg-gray-200"
                                >
                                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path fillRule="evenodd" clipRule="evenodd" d="M17.3892 7.44191L10.4827 0.60791C9.66124 -0.20459 8.33874 -0.20459 7.51724 0.60791L0.614244 7.43891C0.221244 7.82741 0.000244141 8.35791 0.000244141 8.91091V16.9999C0.000244141 17.5524 0.447744 17.9999 1.00024 17.9999H7.00024V12.2499C7.00024 12.1119 7.11174 11.9999 7.25024 11.9999H10.7502C10.8882 11.9999 11.0002 12.1119 11.0002 12.2499V17.9999H17.0002C17.5522 17.9999 18.0002 17.5524 18.0002 16.9999V8.90591C18.0002 8.35591 17.7797 7.82891 17.3892 7.44191" fill="black" fillOpacity="0.73"/>
                                    </svg>
                                </button>

                                {/* 右寄せ: カメラ・音声・マップボタンコンテナ */}
                                <div className="flex items-center bg-gray-100 rounded-full px-1">
                                    {/* カメラボタン */}
                                    <button
                                        onClick={() => setShowCameraMenu(!showCameraMenu)}
                                        className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-gray-700 hover:bg-gray-50 transition-all mx-0.5"
                                    >
                                        <svg width="18" height="16" viewBox="0 0 18 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path fillRule="evenodd" clipRule="evenodd" d="M15.5 6C14.948 6 14.5 5.5525 14.5 4.999C14.5 4.4475 14.948 4 15.5 4C16.052 4 16.5 4.4475 16.5 4.999C16.5 5.5525 16.052 6 15.5 6M9 13.5C6.515 13.5 4.5 11.483 4.5 9C4.5 6.5165 6.515 4.5 9 4.5C11.483 4.5 13.5 6.5165 13.5 9C13.5 11.483 11.483 13.5 9 13.5M16 2H13.5L11.793 0.293C11.6055 0.1055 11.351 0 11.0855 0H6.9145C6.649 0 6.3945 0.1055 6.207 0.293L4.5 2H2C0.9 2 0 2.9 0 4V14C0 15.1 0.9 16 2 16H16C17.1 16 18 15.1 18 14V4C18 2.9 17.1 2 16 2M9 6.30005C7.511 6.30005 6.3 7.51105 6.3 9.00005C6.3 10.4886 7.511 11.7001 9 11.7001C10.489 11.7001 11.7 10.4886 11.7 9.00005C11.7 7.51105 10.489 6.30005 9 6.30005" fill="black" fillOpacity="0.73"/>
                                        </svg>
                                    </button>

                                    {/* 音声ボタン */}
                                    <button
                                        onClick={() => setShowVoiceMenu(!showVoiceMenu)}
                                        className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-gray-700 hover:bg-gray-50 transition-all mx-0.5"
                                    >
                                        <svg width="12" height="20" viewBox="0 0 12 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M1.5 9.5V10.5C1.5 12.9815 3.519 15 6 15C8.481 15 10.5 12.9815 10.5 10.5V9.5H12V10.5C12 13.4675 9.83297 15.9312 7 16.4092V18H8.75C9.1645 18 9.5 18.3355 9.5 18.75C9.5 19.1645 9.1645 19.5 8.75 19.5H3.25C2.8355 19.5 2.5 19.1645 2.5 18.75C2.5 18.3355 2.8355 18 3.25 18H5V16.4092C2.16703 15.9312 0 13.4675 0 10.5V9.5H1.5ZM6 0.5C7.6565 0.5 9 1.8435 9 3.5V10.5C9 12.1565 7.6565 13.5 6 13.5C4.3435 13.5 3 12.1565 3 10.5V3.5C3 1.8435 4.3435 0.5 6 0.5Z" fill="black" fillOpacity="0.73"/>
                                        </svg>
                                    </button>

                                    {/* お気に入りリストボタン（アクティブ状態） */}
                                    <button
                                        onClick={() => {
                                            try {
                                                console.log('お気に入りページでボタンクリック、メインページに戻る');
                                                setCurrentView('map');
                                            } catch (error) {
                                                console.error('メインページ戻りエラー:', error);
                                            }
                                        }}
                                        className="w-10 h-10 rounded-full bg-blue-500 hover:bg-blue-600 flex items-center justify-center text-white transition-all mx-0.5 relative"
                                        title="お気に入りリスト（メインページに戻る）"
                                    >
                                        <svg width="16" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                                        </svg>
                                        {favoriteReports.length > 0 && (
                                            <div className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-normal rounded-full w-5 h-5 flex items-center justify-center">
                                                {favoriteReports.length}
                                            </div>
                                        )}
                                    </button>
                                </div>
                            </div>
                        </nav>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    <ParticleSystem />
                    
                    {/* 記事詳細モーダル */}
                    {console.log('モーダル表示チェック:', { showArticleDetail, selectedArticle: !!selectedArticle, currentView })}
                    {showArticleDetail && selectedArticle && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
                                {/* 固定ヘッダー（閉じるボタンのみ） */}
                                <div className="absolute top-0 left-0 right-0 z-10 p-4 flex justify-end">
                                    <button
                                        onClick={() => {
                                            setShowArticleDetail(false);
                                            // 前の画面に戻る
                                            if (previousView === 'favorites') {
                                                setShowFavorites(true);
                                            } else if (previousView === 'favoritesList') {
                                                setCurrentView('favorites');
                                            }
                                            // メイン画面の場合は何もしない（既に表示されている）
                                            setPreviousView(null); // リセット
                                        }}
                                        className="w-10 h-10 bg-black/20 hover:bg-black/40 rounded-full flex items-center justify-center text-white transition-all"
                                    >
                                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M15 5L5 15M5 5l10 10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        </svg>
                                    </button>
                                </div>

                                {/* スクロール可能なコンテンツ */}
                                <div className="overflow-y-auto max-h-[90vh]">
                                    {/* 記事画像 */}
                                    <div className="relative">
                                        <div className="h-48 bg-gradient-to-br from-blue-500 to-purple-600 relative overflow-hidden">
                                            <img 
                                                src="https://s.yimg.jp/images/ksk/tool/img/photo01.png" 
                                                alt={selectedArticle.title}
                                                className="w-full h-full object-cover opacity-80"
                                            />
                                            <div className="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent"></div>
                                            
                                            {/* 話題度バッジ */}
                                            <div className={`absolute top-4 left-4 px-3 py-1 rounded-full text-white text-sm font-medium ${
                                                selectedArticle.topicalityScore >= 80 ? 'bg-red-500' : 
                                                selectedArticle.topicalityScore >= 60 ? 'bg-orange-500' : 
                                                selectedArticle.topicalityScore >= 40 ? 'bg-yellow-500' : 'bg-gray-500'
                                            }`}>
                                                話題度 {Math.round(selectedArticle.topicalityScore)}
                                            </div>
                                        </div>
                                    </div>

                                    {/* コンテンツ */}
                                    <div className="p-6">
                                    {/* タイトル */}
                                    <h1 className={`text-2xl font-bold font-${selectedFont} text-gray-900 mb-4 leading-tight`}>
                                        {selectedArticle.title}
                                    </h1>
                                    
                                    {/* メタ情報 */}
                                    <div className="flex items-center gap-4 mb-6 text-sm text-gray-500">
                                        <span className="flex items-center gap-2">
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M8 0C3.6 0 0 3.6 0 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm0 14c-3.3 0-6-2.7-6-6s2.7-6 6-6 6 2.7 6 6-2.7 6-6 6zm1-10H7v5l4 2.4.8-1.2-3.8-2.2V4z" fill="currentColor"/>
                                            </svg>
                                            {new Date().toLocaleDateString('ja-JP')}
                                        </span>
                                        <span className="flex items-center gap-2">
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M2 4.5C2 3.67157 2.67157 3 3.5 3H12.5C13.3284 3 14 3.67157 14 4.5V11.5C14 12.3284 13.3284 13 12.5 13H3.5C2.67157 13 2 12.3284 2 11.5V4.5ZM3.5 4C3.22386 4 3 4.22386 3 4.5V5.5L8 8.5L13 5.5V4.5C13 4.22386 12.7761 4 12.5 4H3.5ZM13 6.5L8 9.5L3 6.5V11.5C3 11.7761 3.22386 12 3.5 12H12.5C12.7761 12 13 11.7761 13 11.5V6.5Z" fill="currentColor"/>
                                            </svg>
                                            {selectedArticle.source}
                                        </span>
                                    </div>
                                    
                                    {/* 記事本文 */}
                                    <div className="prose max-w-none mb-6">
                                        <p className={`text-gray-700 font-${selectedFont} leading-relaxed text-base mb-4`}>
                                            {selectedArticle.snippet}
                                        </p>

                                        {/* 詳細内容（サンプル） */}
                                        <p className={`text-gray-700 font-${selectedFont} leading-relaxed text-base mb-4`}>
                                            この記事では、{selectedArticle.title}について詳しく解説します。最新の動向や技術的な詳細、今後の展望についても触れながら、読者の皆様にとって有益な情報をお届けします。
                                        </p>

                                        <p className={`text-gray-700 font-${selectedFont} leading-relaxed text-base mb-4`}>
                                            {selectedArticle.tags.includes('AI') && 'AI技術の進歩により、私たちの生活は大きく変化しています。'}
                                            {selectedArticle.tags.includes('技術') && 'この技術革新は、産業界全体に影響を与えています。'}
                                            {selectedArticle.tags.includes('ビジネス') && 'ビジネスの世界では、新しいビジネスモデルが次々と生まれています。'}
                                            {selectedArticle.tags.includes('料理') && '食文化の多様性と伝統の継承について考える機会となります。'}
                                            今後の動向にも注目していく必要があります。
                                        </p>
                                    </div>
                                    
                                    {/* タグ */}
                                    <div className="mb-6">
                                        <div className="flex flex-wrap gap-2">
                                            {selectedArticle.tags.map(tag => (
                                                <span
                                                    key={tag}
                                                    className="px-3 py-1.5 bg-blue-100 text-blue-700 text-sm rounded-full font-medium hover:bg-blue-200 transition-colors cursor-pointer"
                                                    onClick={() => {
                                                        handleTagClick(tag);
                                                        setShowArticleDetail(false);
                                                        setCurrentView('map');
                                                    }}
                                                >
                                                    #{tag}
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* アクションボタン */}
                                    <div className="flex justify-center pt-4 border-t">
                                        <button
                                            onClick={() => setShowArticleDetail(false)}
                                            className="px-6 py-3 border border-gray-300 hover:border-gray-400 text-gray-700 rounded-lg font-medium transition-colors"
                                        >
                                            閉じる
                                        </button>
                                    </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* お気に入り集約ページ */}
                    {showFavorites && (
                        <div className="fixed inset-0 bg-white z-50 overflow-y-auto">
                            {/* ヘッダー */}
                            <div className="bg-white border-b border-gray-200 sticky top-0 z-10 relative">
                                <div className="relative p-2">
                                    {/* 右上固定：閉じるボタン */}
                                    <button
                                        onClick={() => {
                                            console.log('集約レポート閉じるボタン、previousView:', previousView);
                                            setShowFavorites(false);
                                            // 前の画面に戻る
                                            if (previousView === 'favoritesList') {
                                                console.log('お気に入りリストに戻る');
                                                setCurrentView('favorites');
                                                setPreviousView(null);
                                            } else if (previousView === 'main') {
                                                console.log('マップビューに戻る');
                                                setCurrentView('map');
                                                setPreviousView(null);
                                            } else {
                                                console.log('メイン画面に戻る');
                                            }
                                        }}
                                        className="absolute top-2 right-2 w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center transition-colors z-10"
                                    >
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>

                                    {/* 中央：集約レポートラベルとタグ */}
                                    <div className="flex flex-col items-center justify-center pt-2">
                                        {/* 中央上：タグ組み合わせ */}
                                        <div className={`text-m text-center font-${selectedFont} text-gray-900 pr-11 pl-11`}>
                                            {selectedTags.length > 0 ? selectedTags.join(' × ') : '未選択'}
                                        </div>

                                        {/* 下部：アイコン配置 */}
                                        <div className="flex items-center justify-center gap-4 relative w-full">
                                            {/* 左：時計アイコン */}
                                            <div className="text-gray-500">
                                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18Z" stroke="currentColor" strokeWidth="1.5"/>
                                                    <path d="M10 6V10L13 13" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                                                </svg>
                                            </div>

                                            {/* 中央：お気に入りボタン */}
                                            <button
                                                onClick={(e) => {
                                                    console.log('📊 集約レポートお気に入りボタンクリック:', selectedTags.join(' × '));
                                                    e.stopPropagation();
                                                    toggleFavorites({
                                                        title: `集約レポート: ${selectedTags.join(' × ')}`,
                                                        type: 'aggregated',
                                                        tags: selectedTags,
                                                        articleCount: getMapFilteredArticles().length
                                                    }, e);
                                                }}
                                                className={`w-8 h-8 rounded-full flex items-center justify-center transition-colors ${
                                                    isFavorite({
                                                        title: `集約レポート: ${selectedTags.join(' × ')}`,
                                                        type: 'aggregated',
                                                        tags: selectedTags
                                                    }) ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600'
                                                }`}
                                                title={isFavorite({
                                                    title: `集約レポート: ${selectedTags.join(' × ')}`,
                                                    type: 'aggregated',
                                                    tags: selectedTags
                                                }) ? "お気に入りから削除" : "お気に入りに追加"}
                                            >
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill={isFavorite({
                                                    title: `集約レポート: ${selectedTags.join(' × ')}`,
                                                    type: 'aggregated',
                                                    tags: selectedTags
                                                }) ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>

                                </div>
                                
                                {/* AIヘルプポップアップ */}
                                {showAiHelp && (
                                    <div className="absolute top-full right-4 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg p-4 w-80 z-30">
                                        <div className="flex justify-between items-start mb-3">
                                            <h4 className="font-handwriting text-gray-900">AI要約機能について</h4>
                                            <button
                                                onClick={() => setShowAiHelp(false)}
                                                className="text-gray-400 hover:text-gray-600"
                                            >
                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M12 4L4 12M4 4l8 8" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                                                </svg>
                                            </button>
                                        </div>
                                        <p className="text-sm text-gray-600 leading-relaxed">
                                            選択されたタグに関連する記事から、最新のトレンドと重要なポイントを抽出しています。これらの分野での情報や動向について、包括的な視点で分析し、要約を生成しています。
                                        </p>
                                    </div>
                                )}
                            </div>

                            {/* コンテンツ */}
                            <div className="py-4">
                                {selectedTags.length > 0 ? (
                                    <>
                                        {/* AI話題・トレンド分析セクション */}
                                        <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg mx-4 p-4 mb-6">
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                                                    </svg>
                                                </div>
                                                <h3 className={`text-lg font-${selectedFont} text-gray-900`}>AI話題分析</h3>
                                                <button
                                                    onClick={async () => {
                                                        console.log('🚀 分析開始ボタンクリック - selectedTags:', selectedTags);
                                                        console.log('🔑 現在のAPIキー:', GEMINI_API_KEY ? '設定済み' : '未設定');
                                                        await generateVisualReport(selectedTags, articles);
                                                        console.log('✅ レポート生成完了 - 分析結果を表示');
                                                        setShowAnalysisResults(true);
                                                    }}
                                                    disabled={isGeneratingReport}
                                                    className={`ml-auto px-6 py-3 rounded-lg text-sm font-${selectedFont} font-medium transition-all ${
                                                        isGeneratingReport
                                                            ? 'bg-gray-400 text-gray-200 cursor-not-allowed'
                                                            : 'bg-gradient-to-r from-blue-600 to-purple-600 text-white hover:from-blue-700 hover:to-purple-700 shadow-lg hover:shadow-xl'
                                                    }`}
                                                >
                                                    {isGeneratingReport ? (
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                                            AI分析中...
                                                        </div>
                                                    ) : (
                                                        '🤖 AI分析開始'
                                                    )}
                                                </button>
                                            </div>

                                            <div className="text-sm text-gray-600 bg-white/50 rounded-lg p-3">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                                                    </svg>
                                                    <span className={`font-${selectedFont} font-medium text-gray-700`}>
                                                        リアルタイムAI分析
                                                    </span>
                                                </div>
                                                <p className="text-xs text-gray-500">
                                                    Gemini AIが最新のWebトレンドを分析し、実際の人気コンテンツや話題キーワードを抽出します
                                                </p>
                                            </div>
                                        </div>

                                        {/* キーワードセクション */}
                                        {generatedReport && generatedReport.keywords && showAnalysisResults &&
                                         (generatedReport.keywords.trending?.length > 0 || generatedReport.keywords.related?.length > 0 || generatedReport.keywords.hot?.length > 0 || generatedReport.keywords.analysis) && (
                                            <div className="mx-4 mb-6">
                                                <div className="bg-white border border-gray-200 rounded-lg p-4">
                                                    <div className="space-y-4">
                                                        {/* 急上昇ワード */}
                                                        {generatedReport.keywords.trending && generatedReport.keywords.trending.length > 0 && (
                                                            <div>
                                                                <h4 className={`text-sm font-${selectedFont} text-gray-900 mb-3 flex items-center gap-2`}>
                                                                    🔥 急上昇ワード
                                                                </h4>
                                                                <div className="flex flex-wrap gap-2">
                                                                    {generatedReport.keywords.trending.map((keyword, index) => (
                                                                        <button
                                                                            key={index}
                                                                            onClick={() => handleKeywordClick(keyword, '急上昇ワード')}
                                                                            className={`px-3 py-1.5 bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-full text-sm font-${selectedFont} text-red-700 hover:from-red-100 hover:to-orange-100 hover:border-red-300 transition-all cursor-pointer`}
                                                                        >
                                                                            # {keyword}
                                                                        </button>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}

                                                        {/* 関連キーワード */}
                                                        {generatedReport.keywords.related && generatedReport.keywords.related.length > 0 && (
                                                            <div>
                                                                <h4 className={`text-sm font-${selectedFont} text-gray-900 mb-3 flex items-center gap-2`}>
                                                                    🔗 関連キーワード
                                                                </h4>
                                                                <div className="flex flex-wrap gap-2">
                                                                    {generatedReport.keywords.related.map((keyword, index) => (
                                                                        <button
                                                                            key={index}
                                                                            onClick={() => handleKeywordClick(keyword, '関連キーワード')}
                                                                            className={`px-3 py-1.5 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-full text-sm font-${selectedFont} text-blue-700 hover:from-blue-100 hover:to-indigo-100 hover:border-blue-300 transition-all cursor-pointer`}
                                                                        >
                                                                            # {keyword}
                                                                        </button>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}

                                                        {/* 話題キーワード */}
                                                        {generatedReport.keywords.hot && generatedReport.keywords.hot.length > 0 && (
                                                            <div>
                                                                <h4 className={`text-sm font-${selectedFont} text-gray-900 mb-3 flex items-center gap-2`}>
                                                                    💡 話題キーワード
                                                                </h4>
                                                                <div className="flex flex-wrap gap-2">
                                                                    {generatedReport.keywords.hot.map((keyword, index) => (
                                                                        <button
                                                                            key={index}
                                                                            onClick={() => handleKeywordClick(keyword, '話題キーワード')}
                                                                            className={`px-3 py-1.5 bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-full text-sm font-${selectedFont} text-purple-700 hover:from-purple-100 hover:to-pink-100 hover:border-purple-300 transition-all cursor-pointer`}
                                                                        >
                                                                            # {keyword}
                                                                        </button>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}

                                                        {/* AI分析情報 */}
                                                        {generatedReport.keywords && generatedReport.keywords.analysis && (
                                                            <div>
                                                                <h4 className={`text-sm font-${selectedFont} text-gray-900 mb-3 flex items-center gap-2`}>
                                                                    🤖 AI分析レポート
                                                                </h4>
                                                                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-3 border border-blue-100">
                                                                    <p className={`text-sm font-${selectedFont} text-gray-800 mb-2`}>
                                                                        {generatedReport.keywords.analysis}
                                                                    </p>
                                                                    {generatedReport.keywords.sources && (
                                                                        <div className="text-xs text-gray-600">
                                                                            <span>データソース: </span>
                                                                            {generatedReport.keywords.sources.join(', ')}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* ビジュアル分析レポート表示 */}
                                        {generatedReport && generatedReport.topics && showAnalysisResults && (
                                            <div className="mx-4 mb-6 space-y-6">
                                                {/* ヘッダー */}
                                                <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-t-lg">
                                                    <div className="flex items-center justify-between">
                                                        <h3 className={`text-lg font-${selectedFont}`}>
                                                            📊 {generatedReport.tags.join(' × ')} 分析レポート
                                                        </h3>
                                                        <button
                                                            onClick={() => {
                                                                setGeneratedReport(null);
                                                                setShowAnalysisResults(false);
                                                                console.log('🚪 レポートを閉じる：分析結果もリセット');
                                                            }}
                                                            className="text-white/80 hover:text-white"
                                                        >
                                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                                                <path d="M12 4L4 12M4 4l8 8" stroke="currentColor" strokeWidth="1.5"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>

                                                {/* トレンド分析 */}
                                                <div className="bg-white border border-gray-200 rounded-lg p-4">
                                                    <h4 className={`text-md font-${selectedFont} text-gray-900 mb-4 flex items-center gap-2`}>
                                                        📈 トレンド分析
                                                    </h4>
                                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                        {generatedReport.trends.map((trend, index) => (
                                                            <div key={index} className="bg-gray-50 rounded-lg p-3">
                                                                <div className="flex items-center justify-between mb-2">
                                                                    <span className={`font-${selectedFont} text-sm font-medium`}>
                                                                        {trend.tag}
                                                                    </span>
                                                                    <span className={`text-xs px-2 py-1 rounded ${
                                                                        trend.change > 0
                                                                            ? 'bg-green-100 text-green-800'
                                                                            : 'bg-red-100 text-red-800'
                                                                    }`}>
                                                                        {trend.change > 0 ? '+' : ''}{trend.change.toFixed(1)}%
                                                                    </span>
                                                                </div>
                                                                <div className="h-16 mb-2">
                                                                    <svg width="100%" height="100%" viewBox="0 0 200 60">
                                                                        <polyline
                                                                            points={trend.trend.map((point, i) =>
                                                                                `${(i / (trend.trend.length - 1)) * 180 + 10},${60 - (point.value / 100) * 50}`
                                                                            ).join(' ')}
                                                                            fill="none"
                                                                            stroke={trend.color}
                                                                            strokeWidth="2"
                                                                        />
                                                                    </svg>
                                                                </div>
                                                                <div className="text-xs text-gray-600">
                                                                    現在値: {trend.currentValue.toFixed(0)}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>

                                                {/* 話題・トピック */}
                                                <div className="bg-white border border-gray-200 rounded-lg p-4">
                                                    <h4 className={`text-md font-${selectedFont} text-gray-900 mb-4 flex items-center gap-2`}>
                                                        🔥 話題のトピック
                                                    </h4>
                                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                                        {generatedReport.topics.map((topic, index) => (
                                                            <div key={index} className="relative bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-3 hover:shadow-md transition-shadow">
                                                                <div className="text-center">
                                                                    <div
                                                                        className="w-12 h-12 rounded-full mx-auto mb-2 flex items-center justify-center text-white text-sm font-bold"
                                                                        style={{ backgroundColor: topic.color }}
                                                                    >
                                                                        {Math.round(topic.popularity)}
                                                                    </div>
                                                                    <div className={`font-${selectedFont} text-sm text-gray-900 mb-1`}>
                                                                        {topic.name}
                                                                    </div>
                                                                    <div className="text-xs text-gray-600">
                                                                        {topic.articleCount}件
                                                                    </div>
                                                                    <div className={`text-xs mt-1 ${
                                                                        topic.growth > 0 ? 'text-green-600' : 'text-red-600'
                                                                    }`}>
                                                                        {topic.growth > 0 ? '↗' : '↘'} {Math.abs(topic.growth).toFixed(1)}%
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>

                                                {/* 最新ニュース */}
                                                <div className="bg-white border border-gray-200 rounded-lg p-4">
                                                    <h4 className={`text-md font-${selectedFont} text-gray-900 mb-4 flex items-center gap-2`}>
                                                        📰 関連ニュース
                                                    </h4>
                                                    <div className="space-y-3">
                                                        {generatedReport.news.map((news, index) => (
                                                            <div key={index} className="border border-gray-100 rounded-lg p-3 hover:bg-gray-50 transition-colors">
                                                                <div className="flex items-start justify-between">
                                                                    <div className="flex-1">
                                                                        <h5 className={`font-${selectedFont} text-sm font-medium text-gray-900 mb-1`}>
                                                                            {news.title}
                                                                        </h5>
                                                                        <div className="flex items-center gap-3 text-xs text-gray-600">
                                                                            <span className={`px-2 py-1 rounded ${
                                                                                news.sentiment === 'positive' ? 'bg-green-100 text-green-700' :
                                                                                news.sentiment === 'negative' ? 'bg-red-100 text-red-700' :
                                                                                'bg-gray-100 text-gray-700'
                                                                            }`}>
                                                                                {news.category}
                                                                            </span>
                                                                            <span>{news.date}</span>
                                                                            <span>👁 {news.views.toLocaleString()}</span>
                                                                            <span>🔄 {news.shares}</span>
                                                                        </div>
                                                                    </div>
                                                                    <div className={`w-2 h-2 rounded-full ml-3 mt-2 ${
                                                                        news.sentiment === 'positive' ? 'bg-green-400' :
                                                                        news.sentiment === 'negative' ? 'bg-red-400' :
                                                                        'bg-gray-400'
                                                                    }`}></div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* キーワード詳細モーダル */}
                                        {selectedKeywordDetail && (
                                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                                                <div className="bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                                                    <div className="sticky top-0 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-t-lg">
                                                        <div className="flex items-center justify-between">
                                                            <h3 className={`text-lg font-${selectedFont}`}>
                                                                🔍 {selectedKeywordDetail.keyword} 詳細分析
                                                            </h3>
                                                            <button
                                                                onClick={() => {
                                                                    setSelectedKeywordDetail(null);
                                                                    setIsLoadingKeywordDetail(false);
                                                                }}
                                                                className="text-white/80 hover:text-white"
                                                            >
                                                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                                                    <path d="M15 5L5 15M5 5l10 10" stroke="currentColor" strokeWidth="2"/>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <div className="p-6">
                                                        {/* 概要 */}
                                                        <div className="mb-6">
                                                            <h4 className={`text-md font-${selectedFont} text-gray-900 mb-3 flex items-center gap-2`}>
                                                                📖 概要
                                                            </h4>
                                                            <p className={`text-gray-800 font-${selectedFont} bg-blue-50 p-3 rounded-lg`}>
                                                                {selectedKeywordDetail.explanation}
                                                            </p>
                                                        </div>

                                                        {/* 注目されている理由 */}
                                                        <div className="mb-6">
                                                            <h4 className={`text-md font-${selectedFont} text-gray-900 mb-3 flex items-center gap-2`}>
                                                                🔥 注目されている理由
                                                            </h4>
                                                            <div className="space-y-2">
                                                                {selectedKeywordDetail.reasons.map((reason, index) => (
                                                                    <div key={index} className="flex items-center gap-3 bg-gray-50 p-3 rounded-lg">
                                                                        <div className="w-6 h-6 bg-gradient-to-r from-red-500 to-orange-500 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                                                            {index + 1}
                                                                        </div>
                                                                        <span className={`font-${selectedFont} text-gray-800`}>{reason}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>

                                                        {/* 詳細解説 */}
                                                        <div className="mb-6">
                                                            <h4 className={`text-md font-${selectedFont} text-gray-900 mb-3 flex items-center gap-2`}>
                                                                📚 詳細解説
                                                            </h4>
                                                            <p className={`text-gray-700 font-${selectedFont} bg-gray-50 p-4 rounded-lg leading-relaxed`}>
                                                                {selectedKeywordDetail.details}
                                                            </p>
                                                        </div>

                                                        {/* 関連情報 */}
                                                        {selectedKeywordDetail.trend_type && (
                                                            <div className="mb-6">
                                                                <h4 className={`text-md font-${selectedFont} text-gray-900 mb-3 flex items-center gap-2`}>
                                                                    📊 トレンド情報
                                                                </h4>
                                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                    <div className="bg-purple-50 p-3 rounded-lg">
                                                                        <span className="text-xs text-purple-600 font-medium">トレンド種類</span>
                                                                        <p className={`font-${selectedFont} text-purple-800`}>{selectedKeywordDetail.trend_type}</p>
                                                                    </div>
                                                                    {selectedKeywordDetail.timeline && (
                                                                        <div className="bg-green-50 p-3 rounded-lg">
                                                                            <span className="text-xs text-green-600 font-medium">話題開始時期</span>
                                                                            <p className={`font-${selectedFont} text-green-800`}>{selectedKeywordDetail.timeline}</p>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        )}

                                                        {/* 関連イベント */}
                                                        {selectedKeywordDetail.related_events && selectedKeywordDetail.related_events.length > 0 && (
                                                            <div className="mb-6">
                                                                <h4 className={`text-md font-${selectedFont} text-gray-900 mb-3 flex items-center gap-2`}>
                                                                    🎯 関連する出来事
                                                                </h4>
                                                                <div className="space-y-2">
                                                                    {selectedKeywordDetail.related_events.map((event, index) => (
                                                                        <div key={index} className="flex items-center gap-3 bg-indigo-50 p-3 rounded-lg">
                                                                            <div className="w-4 h-4 bg-indigo-500 rounded-full"></div>
                                                                            <span className={`font-${selectedFont} text-indigo-800`}>{event}</span>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}

                                                        {/* 重要人物・企業 */}
                                                        {selectedKeywordDetail.key_figures && selectedKeywordDetail.key_figures.length > 0 && (
                                                            <div className="mb-6">
                                                                <h4 className={`text-md font-${selectedFont} text-gray-900 mb-3 flex items-center gap-2`}>
                                                                    👥 重要人物・企業
                                                                </h4>
                                                                <div className="space-y-2">
                                                                    {selectedKeywordDetail.key_figures.map((figure, index) => (
                                                                        <div key={index} className="flex items-center gap-3 bg-emerald-50 p-3 rounded-lg">
                                                                            <div className="w-4 h-4 bg-emerald-500 rounded-full"></div>
                                                                            <span className={`font-${selectedFont} text-emerald-800`}>{figure}</span>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}

                                                        {/* 社会・業界への影響 */}
                                                        {selectedKeywordDetail.impact && (
                                                            <div className="mb-6">
                                                                <h4 className={`text-md font-${selectedFont} text-gray-900 mb-3 flex items-center gap-2`}>
                                                                    📊 社会・業界への影響
                                                                </h4>
                                                                <p className={`text-gray-700 font-${selectedFont} bg-yellow-50 p-4 rounded-lg leading-relaxed border border-yellow-200`}>
                                                                    {selectedKeywordDetail.impact}
                                                                </p>
                                                            </div>
                                                        )}

                                                        {/* データソース */}
                                                        {selectedKeywordDetail.sources && (
                                                            <div className="pt-4 border-t border-gray-200">
                                                                <h4 className={`text-sm font-${selectedFont} text-gray-600 mb-2`}>情報源:</h4>
                                                                <div className="flex flex-wrap gap-2">
                                                                    {selectedKeywordDetail.sources.map((source, index) => (
                                                                        <span key={index} className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">
                                                                            {source}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}

                                                        {/* アクションボタン */}
                                                        <div className="pt-6 border-t border-gray-200 mt-6">
                                                            <div className="flex gap-3 justify-end">
                                                                <button
                                                                    onClick={() => {
                                                                        setSelectedKeywordDetail(null);
                                                                        setIsLoadingKeywordDetail(false);
                                                                    }}
                                                                    className={`px-4 py-2 text-gray-600 hover:text-gray-800 font-${selectedFont} transition-colors`}
                                                                >
                                                                    閉じる
                                                                </button>
                                                                <button
                                                                    onClick={() => handleGenerateReportFromKeyword(selectedKeywordDetail.keyword)}
                                                                    className={`px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 font-${selectedFont} transition-all flex items-center gap-2`}
                                                                >
                                                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                                                        <path d="M8 3V13M3 8H13" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>
                                                                    </svg>
                                                                    新しいレポート生成
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {/* ローディング中のキーワード詳細 */}
                                        {isLoadingKeywordDetail && (
                                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                                                <div className="bg-white rounded-lg p-8 text-center">
                                                    <div className="w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
                                                    <p className={`font-${selectedFont} text-gray-700`}>キーワード詳細を分析中...</p>
                                                </div>
                                            </div>
                                        )}

                                        {/* 選択タグの要約 */}
                                        <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg mx-4 px-4 mb-4">
                                            <div className="mb-3">
                                                <div className="flex-1">
                                                </div>
                                            </div>
                                        </div>

                                        {/* カテゴリータブ */}
                                        <div className="mb-4">
                                            <div className="flex gap-2 overflow-x-auto pb-2 px-4">
                                                {(() => {
                                                    // 選択タグに応じたカテゴリーメニューを動的に生成
                                                    if (selectedTags.includes('旅行') || selectedTags.includes('沖縄')) {
                                                        return ['プラン', 'グルメ', '観光', '写真', 'アクティビティ'];
                                                    } else if (selectedTags.includes('料理') || selectedTags.includes('和食')) {
                                                        return ['レシピ', 'レストラン', '食材', '調理法', '栄養'];
                                                    } else if (selectedTags.includes('AI') || selectedTags.includes('技術')) {
                                                        return ['トレンド', 'ツール', '事例', '学習', '研究'];
                                                    } else if (selectedTags.includes('ビジネス')) {
                                                        return ['戦略', 'マーケティング', '事例', 'ツール', 'ニュース'];
                                                    } else if (selectedTags.includes('動物') || selectedTags.includes('ペット')) {
                                                        return ['飼育', '健康', '用品', 'トレーニング', '種類'];
                                                    } else if (selectedTags.includes('ファッション')) {
                                                        return ['トレンド', 'ブランド', 'コーデ', 'アイテム', 'セール'];
                                                    } else {
                                                        return ['おすすめ', 'トレンド', 'ニュース', 'ガイド', 'レビュー'];
                                                    }
                                                })().map((category, index) => (
                                                    <button
                                                        key={category}
                                                        className={`px-4 py-2 rounded-full whitespace-nowrap transition-all ${
                                                            index === 0 
                                                                ? 'bg-blue-600 text-white'
                                                                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                                        }`}
                                                    >
                                                        {category}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        {/* 関連記事 */}
                                        <div>
                                            {/* トップ5記事（カルーセル） */}
                                            <div className="mb-6">
                                                <div className="flex gap-4 overflow-x-auto pb-4 scrollbar-hide pl-4">
                                                    {getMapFilteredArticles().slice(0, 5).map((article, index) => (
                                                        <div
                                                            key={index}
                                                            className={`flex-shrink-0 w-72 bg-white rounded-lg border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow cursor-pointer ${index === 4 ? 'mr-4' : ''}`}
                                                            onClick={(e) => {
                                                                console.log('カルーセル記事クリック:', article.title);
                                                                handleArticleRead(article, e);
                                                            }}
                                                        >
                                                            <div className="aspect-video bg-gray-200 relative">
                                                                <img 
                                                                    src="https://s.yimg.jp/images/ksk/tool/img/photo01.png"
                                                                    alt={article.title}
                                                                    className="w-full h-full object-cover"
                                                                />
                                                                <div className="absolute top-2 right-2 bg-black/70 text-white px-2 py-1 rounded text-xs font-normal">
                                                                    #{index + 1}
                                                                </div>
                                                            </div>
                                                            <div className="p-4">
                                                                <h3 className={`font-${selectedFont} text-gray-900 mb-2 line-clamp-2`}>
                                                                    {article.title}
                                                                </h3>
                                                                <p className={`text-sm text-gray-600 font-${selectedFont} mb-3 line-clamp-2`}>
                                                                    {article.snippet}
                                                                </p>
                                                                <div className="flex items-center justify-between text-xs text-gray-400">
                                                                    <span>{article.source}</span>
                                                                    <span>話題度: {Math.round(article.topicalityScore)}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* 残りの記事（リスト） */}
                                            {getMapFilteredArticles().length > 5 && (
                                                <div className="mx-4">
                                                    <h3 className={`text-m font-bold font-${selectedFont} text-gray-900 mb-3`}>その他の記事</h3>
                                                    <div className="space-y-3">
                                                        {getMapFilteredArticles().slice(5).map((article, index) => (
                                                            <div
                                                                key={index + 5}
                                                                className="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow cursor-pointer"
                                                                onClick={(e) => {
                                                                    console.log('リスト記事クリック:', article.title);
                                                                    handleArticleRead(article, e);
                                                                }}
                                                            >
                                                                <div className="flex gap-4">
                                                                    <div className="w-20 h-20 bg-gray-200 rounded-lg overflow-hidden flex-shrink-0">
                                                                        <img 
                                                                            src="https://s.yimg.jp/images/ksk/tool/img/photo01.png"
                                                                            alt={article.title}
                                                                            className="w-full h-full object-cover"
                                                                        />
                                                                    </div>
                                                                    <div className="flex-1 min-w-0">
                                                                        <div className="flex items-start justify-between mb-2">
                                                                            <h4 className={`font-${selectedFont} text-gray-900 line-clamp-2 flex-1`}>
                                                                                {article.title}
                                                                            </h4>
                                                                        </div>
                                                                        <p className={`text-sm text-gray-600 font-${selectedFont} mb-2 line-clamp-1`}>
                                                                            {article.snippet}
                                                                        </p>
                                                                        <div className="flex items-center justify-between text-xs text-gray-400">
                                                                            <span>{article.source}</span>
                                                                            <span>話題度: {Math.round(article.topicalityScore)}</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </>
                                ) : (
                                    /* タグ未選択時の表示 */
                                    <div className="text-center py-12 px-6">
                                        <div className="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6">
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" stroke="#3b82f6" strokeWidth="2" fill="none" strokeLinecap="round" strokeLinejoin="round"/>
                                                <circle cx="7" cy="7" r="1.5" fill="#3b82f6"/>
                                            </svg>
                                        </div>
                                        <h3 className="text-xl font-medium text-gray-900 mb-4">レポート作成にはタグ選択が必要です</h3>
                                        <div className="space-y-3 text-gray-600 mb-8 max-w-md mx-auto">
                                            <p>• マップ画面でタグノード（○）をクリック</p>
                                            <p>• または記事リスト内のタグをクリック</p>
                                            <p>• 選択したタグに関連する記事の集約レポートが作成されます</p>
                                        </div>
                                        <button
                                            onClick={() => {
                                                setShowFavorites(false);
                                                setCurrentView('map');
                                            }}
                                            className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium transition-colors"
                                        >
                                            マップに戻る
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    <main className="max-w-6xl mx-auto p-4 relative z-10 pb-20">
                        {/* マップビュー：全画面レイアウト */}
                        {currentView === 'map' && (
                            <div className="fixed inset-0 top-0 bg-gray-50">
                                {/* マップエリア（上半分） */}
                                <div 
                                    className="relative"
                                    style={{ height: `${100 - mapArticleAreaHeight}vh` }}
                                >
                                    
                                    <div 
                                        id="map-container" 
                                        className="w-full h-full bg-gray-900 relative"
                                    >
                                        <svg 
                                            id="mapSvg" 
                                            className="w-full h-full network-bg"
                                        ></svg>
                                        

                                        {/* バランスバー (マップ下部) */}
                                        <div className="absolute bottom-2 left-6 right-6 z-10">
                                            <div className="flex items-center gap-3">
                                                <input
                                                    type="range"
                                                    min="0"
                                                    max="100"
                                                    value={interestDepth}
                                                    onChange={(e) => setInterestDepth(Number(e.target.value))}
                                                    className="flex-1 h-2 bg-gray-300 rounded-full appearance-none cursor-pointer slider-thumb balance-bar-bg"
                                                />
                                                <button
                                                    onClick={() => setShowBalanceInfo(!showBalanceInfo)}
                                                    className="w-8 h-8 bg-black text-white rounded-full flex items-center justify-center hover:bg-gray-800 transition-colors border-2 border-white/30 hover:border-white/50"
                                                >
                                                    <span className="text-sm font-bold">!</span>
                                                </button>
                                            </div>
                                            
                                            {/* 情報ポップアップ */}
                                            {showBalanceInfo && (
                                                <div className="absolute bottom-12 right-0 bg-black text-white p-4 rounded-lg shadow-lg w-80 text-sm">
                                                    <div className="mb-3">
                                                        {(() => {
                                                            const depthInfo = getDepthInfo(interestDepth);
                                                            return (
                                                                <>
                                                                    <div className="font-semibold text-lg mb-2">{depthInfo.label} ({interestDepth}%)</div>
                                                                    <div className="text-gray-300">{depthInfo.description}</div>
                                                                </>
                                                            );
                                                        })()}
                                                    </div>
                                                    
                                                    <div className="space-y-2 text-xs">
                                                        <div className="flex items-center gap-2">
                                                            <span>💜</span>
                                                            <span className="text-purple-300">0-30%: 私的興味</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <span>💙</span>
                                                            <span className="text-blue-300">30-70%: バランス</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <span>💚</span>
                                                            <span className="text-green-300">70-100%: パーソナル</span>
                                                        </div>
                                                    </div>
                                                    
                                                    <button
                                                        onClick={() => setShowBalanceInfo(false)}
                                                        className="absolute top-2 right-2 w-6 h-6 bg-gray-600 hover:bg-gray-500 rounded-full flex items-center justify-center text-xs"
                                                    >
                                                        ×
                                                    </button>
                                                </div>
                                            )}
                                        </div>

                                    </div>
                                </div>

                                {/* 記事エリア（下半分） */}
                                <div 
                                    className="relative bg-white border-t-2 border-gray-200"
                                    style={{ 
                                        height: `${mapArticleAreaHeight}vh`,
                                        transition: isDragging ? 'none' : 'height 0.3s ease'
                                    }}
                                >
                                    {/* ドラッグハンドル */}
                                    <div 
                                        className="absolute top-0 left-0 right-0 h-6 flex items-center justify-center cursor-grab active:cursor-grabbing bg-gray-100 hover:bg-gray-200 transition-colors z-10"
                                        onMouseDown={(e) => {
                                            setIsDragging(true);
                                            const startY = e.clientY;
                                            const startHeight = mapArticleAreaHeight;

                                            const handleMouseMove = (e) => {
                                                const deltaY = startY - e.clientY;
                                                const newHeight = Math.min(Math.max(20, startHeight + (deltaY / window.innerHeight) * 100), 80);
                                                setMapArticleAreaHeight(newHeight);
                                            };

                                            const handleMouseUp = () => {
                                                setIsDragging(false);
                                                document.removeEventListener('mousemove', handleMouseMove);
                                                document.removeEventListener('mouseup', handleMouseUp);
                                            };

                                            document.addEventListener('mousemove', handleMouseMove);
                                            document.addEventListener('mouseup', handleMouseUp);
                                        }}
                                        onTouchStart={(e) => {
                                            setIsDragging(true);
                                            const startY = e.touches[0].clientY;
                                            const startHeight = mapArticleAreaHeight;

                                            const handleTouchMove = (e) => {
                                                const deltaY = startY - e.touches[0].clientY;
                                                const newHeight = Math.min(Math.max(20, startHeight + (deltaY / window.innerHeight) * 100), 80);
                                                setMapArticleAreaHeight(newHeight);
                                            };

                                            const handleTouchEnd = () => {
                                                setIsDragging(false);
                                                document.removeEventListener('touchmove', handleTouchMove);
                                                document.removeEventListener('touchend', handleTouchEnd);
                                            };

                                            document.addEventListener('touchmove', handleTouchMove);
                                            document.addEventListener('touchend', handleTouchEnd);
                                        }}
                                    >
                                        <div className="w-12 h-1 bg-gray-300 rounded-full"></div>
                                    </div>

                                    {/* ビュー切り替えボタン（右端固定） */}
                                    <div className="absolute top-0 right-4 z-20 flex bg-gray-100 rounded-lg p-1 shadow-lg">
                                        <button
                                            onClick={() => setMapViewMode('grid')}
                                            className={`p-1.5 rounded transition-all ${
                                                mapViewMode === 'grid' 
                                                ? 'bg-white text-gray-900 shadow-sm' 
                                                : 'text-gray-500 hover:text-gray-700'
                                            }`}
                                        >
                                            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="1" y="1" width="5" height="5" rx="1" fill="currentColor"/>
                                                <rect x="8" y="1" width="5" height="5" rx="1" fill="currentColor"/>
                                                <rect x="1" y="8" width="5" height="5" rx="1" fill="currentColor"/>
                                                <rect x="8" y="8" width="5" height="5" rx="1" fill="currentColor"/>
                                            </svg>
                                        </button>
                                        <button
                                            onClick={() => setMapViewMode('list')}
                                            className={`p-1.5 rounded transition-all ${
                                                mapViewMode === 'list' 
                                                ? 'bg-white text-gray-900 shadow-sm' 
                                                : 'text-gray-500 hover:text-gray-700'
                                            }`}
                                        >
                                            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="1" y="2" width="12" height="1.5" rx="0.75" fill="currentColor"/>
                                                <rect x="1" y="6" width="12" height="1.5" rx="0.75" fill="currentColor"/>
                                                <rect x="1" y="10" width="12" height="1.5" rx="0.75" fill="currentColor"/>
                                            </svg>
                                        </button>
                                        <button
                                            onClick={() => {
                                                console.log('集約ボタンクリック: マップビューから');
                                                setPreviousView('main'); // マップビューから来たことを記録
                                                setShowFavorites(true);
                                            }}
                                            className="p-1.5 rounded transition-all text-gray-500 hover:text-gray-700"
                                            title="お気に入り集約"
                                        >
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                {/* ブックマークアイコン（お気に入りリストと同じ） */}
                                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                                {/* プラスアイコン */}
                                                <circle cx="18" cy="6" r="6" fill="currentColor" stroke="white" strokeWidth="1"/>
                                                <path d="M15.5 6h5M18 3.5v5" stroke="white" strokeWidth="1.3" strokeLinecap="round" strokeLinejoin="round"/>
                                            </svg>
                                        </button>
                                    </div>

                                    {/* 記事コンテンツ */}
                                    <div className="pt-11 pb-4 px-4 h-full overflow-y-auto">
                                        {/* フィルタヘッダー */}
                                        <div className="mb-3">
                                            {/* フィルタ表示（横スクロール1行） */}
                                            {selectedTags.length > 0 && (
                                                <div className="flex items-center gap-2 text-sm text-gray-500 overflow-x-auto scrollbar-hide">
                                                    <div className="flex gap-2 flex-nowrap">
                                                        {selectedTags.map(tag => (
                                                            <button
                                                                key={tag}
                                                                onClick={() => {
                                                                    const newTags = selectedTags.filter(t => t !== tag);
                                                                    setSelectedTags(newTags);
                                                                }}
                                                                className="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-600 rounded-full text-xs whitespace-nowrap flex-shrink-0 transition-colors cursor-pointer flex items-center gap-1"
                                                                title={`${tag}を削除`}
                                                            >
                                                                {tag}
                                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                                    <path d="M18 6L6 18M6 6l12 12"/>
                                                                </svg>
                                                            </button>
                                                        ))}
                                                        <button
                                                            onClick={() => {
                                                                console.log('🧹 タグクリア：分析結果もリセット');
                                                                setSelectedTags([]);
                                                                setShowAnalysisResults(false);
                                                                setGeneratedReport(null);
                                                                setSelectedKeywordDetail(null);
                                                            }}
                                                            className="text-blue-600 hover:text-blue-800 text-xs whitespace-nowrap flex-shrink-0"
                                                        >
                                                            クリア
                                                        </button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        {/* 記事一覧 */}
                                        {mapViewMode === 'list' && (
                                            <div className="grid gap-3">
                                            {getMapFilteredArticles().map((article, index) => {
                                                const matchingTags = article.tags.filter(tag => selectedTags.includes(tag));
                                                return (
                                                    <div
                                                        key={index}
                                                        className={`bg-white rounded-lg p-3 shadow-sm border hover:shadow-md transition-all cursor-pointer ${
                                                            matchingTags.length > 0 ? 'ring-2 ring-blue-200 bg-blue-50/30' : ''
                                                        }`}
                                                        onClick={(e) => handleArticleRead(article, e)}
                                                    >
                                                        <div className="flex gap-3">
                                                            <div className="w-12 h-12 bg-gradient-to-br from-blue-100 to-blue-200 rounded-lg overflow-hidden flex-shrink-0 relative">
                                                                <img 
                                                                    src="https://s.yimg.jp/images/ksk/tool/img/photo01.png" 
                                                                    alt={article.title}
                                                                    className="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
                                                                />
                                                                {/* 話題度インジケーター */}
                                                                <div className={`absolute top-0.5 right-0.5 text-white px-1 py-0.5 rounded text-xs-small ${
                                                                    article.topicalityScore >= 80 ? 'bg-red-500' : 
                                                                    article.topicalityScore >= 60 ? 'bg-orange-500' : 
                                                                    article.topicalityScore >= 40 ? 'bg-yellow-600' : 'bg-gray-500/70'
                                                                }`}>
                                                                    {Math.round(article.topicalityScore)}
                                                                </div>
                                                            </div>
                                                            
                                                            <div className="flex-1 min-w-0">
                                                                <div className="flex justify-between items-start mb-1">
                                                                    <h4 className={`font-${selectedFont} text-gray-900 text-sm font-bold line-clamp-2 flex-1`}>{article.title}</h4>
                                                                    {/* お気に入りボタン */}
                                                                    <button
                                                                        onClick={(e) => {
                                                                            console.log('⭐ 記事お気に入りボタンクリック:', article.title);
                                                                            e.stopPropagation();
                                                                            toggleFavorites({
                                                                                title: article.title,
                                                                                type: 'article',
                                                                                tags: article.tags,
                                                                                articleCount: 1,
                                                                                articleData: {
                                                                                    title: article.title,
                                                                                    snippet: article.snippet,
                                                                                    source: article.source,
                                                                                    tags: article.tags
                                                                                }
                                                                            }, e);
                                                                        }}
                                                                        className={`ml-2 flex-shrink-0 ${
                                                                            isFavorite({
                                                                                title: article.title,
                                                                                type: 'article',
                                                                                tags: article.tags
                                                                            }) ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600'
                                                                        } transition-colors`}
                                                                        title={isFavorite({
                                                                            title: article.title,
                                                                            type: 'article',
                                                                            tags: article.tags
                                                                        }) ? "お気に入りから削除" : "お気に入りに追加"}
                                                                    >
                                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill={isFavorite({
                                                                            title: article.title,
                                                                            type: 'article',
                                                                            tags: article.tags
                                                                        }) ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                                                                        </svg>
                                                                    </button>
                                                                </div>
                                                                <p className={`text-xs text-gray-600 font-${selectedFont} mb-2 line-clamp-2`}>{article.snippet}</p>
                                                                <div className="flex items-center justify-between">
                                                                    <span className="text-xs text-gray-400">{article.source}</span>
                                                                    <div className="flex gap-1">
                                                                        {article.tags.slice(0, 2).map(tag => (
                                                                            <span
                                                                                key={tag}
                                                                                className={`px-1.5 py-0.5 text-xs rounded-full ${
                                                                                    selectedTags.includes(tag) 
                                                                                        ? 'bg-yellow-200 text-yellow-800 font-medium'
                                                                                        : 'bg-gray-100 text-gray-600'
                                                                                }`}
                                                                            >
                                                                                {tag}
                                                                            </span>
                                                                        ))}
                                                                        {article.tags.length > 2 && (
                                                                            <span className="px-1.5 py-0.5 bg-gray-100 text-gray-500 text-xs font-normal rounded-full">
                                                                                +{article.tags.length - 2}
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                            </div>
                                        )}
                                        
                                        {/* グリッドビュー（正方形固定） */}
                                        {mapViewMode === 'grid' && (
                                            <div className="grid gap-1 w-full overflow-hidden -mx-1 article-grid">
                                                {getMapFilteredArticles().map((article, index) => {
                                                    const matchingTags = article.tags.filter(tag => selectedTags.includes(tag));
                                                    
                                                    return (
                                                        <div
                                                            key={index}
                                                            className={`relative overflow-hidden cursor-pointer group aspect-square ${
                                                                matchingTags.length > 0 ? 'ring-2 ring-yellow-300' : ''
                                                            }`}
                                                            style={article.staticGridSize}
                                                            onClick={(e) => handleArticleRead(article, e)}
                                                        >
                                                            <img 
                                                                src="https://s.yimg.jp/images/ksk/tool/img/photo01.png" 
                                                                alt={article.title}
                                                                className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                                                            />
                                                            
                                                            {/* オーバーレイ - 大きなアイテムは常時表示、小さなアイテムはホバー時のみ */}
                                                            <div className={`absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent transition-opacity duration-300 ${
                                                                article.topicalityScore >= 60 
                                                                ? 'opacity-100' 
                                                                : 'opacity-0 group-hover:opacity-100'
                                                            }`}>
                                                                <div className="absolute bottom-0 left-0 right-0 p-2">
                                                                    <h4 className={`text-white font-${selectedFont} text-xs line-clamp-2 mb-1`}>
                                                                        {article.title}
                                                                    </h4>
                                                                    <div className="text-white/80 text-xs">
                                                                        話題度: {Math.round(article.topicalityScore)}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* マッチング数インジケーター */}
                                                            {matchingTags.length > 0 && (
                                                                <div className="absolute top-2 left-2 bg-yellow-500 text-black text-xs px-1.5 py-0.5 rounded-full font-normal font-medium">
                                                                    {matchingTags.length}
                                                                </div>
                                                            )}
                                                            
                                                            {/* 話題度インジケーター */}
                                                            <div className={`absolute top-2 right-2 text-white text-xs px-1.5 py-0.5 rounded-full ${
                                                                article.topicalityScore >= 80 ? 'bg-red-500' : 
                                                                article.topicalityScore >= 60 ? 'bg-orange-500' : 
                                                                article.topicalityScore >= 40 ? 'bg-yellow-600' : 'bg-gray-500/70'
                                                            }`}>
                                                                {Math.round(article.topicalityScore)}
                                                            </div>
                                                            
                                                            {/* HOTバッジ */}
                                                            {article.topicalityScore >= 80 && (
                                                                <div className="absolute bottom-2 left-2 bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full font-normal font-bold">
                                                                    HOT
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}

                                        {getMapFilteredArticles().length === 0 && (
                                            <div className="text-center py-8 text-gray-500">
                                                <div className="text-4xl mb-2">📰</div>
                                                <p className={`text-sm font-${selectedFont}`}>関連記事が見つかりません</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* 下部メニューバー */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white/20 backdrop-blur-sm border-t border-gray-200/30 shadow-lg z-50">
                        <div className="flex items-center justify-between px-4 py-2">
                            {/* 左寄せ: ホームボタン（将来的に別画面遷移用） */}
                            <button
                                onClick={() => {
                                    // 将来的にホーム画面や別の画面に遷移予定
                                    console.log('ホームボタンがクリックされました');
                                }}
                                className="w-10 h-10 rounded-full flex items-center justify-center transition-all bg-gray-100 text-gray-600 hover:bg-gray-200"
                            >
                                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path fillRule="evenodd" clipRule="evenodd" d="M17.3892 7.44191L10.4827 0.60791C9.66124 -0.20459 8.33874 -0.20459 7.51724 0.60791L0.614244 7.43891C0.221244 7.82741 0.000244141 8.35791 0.000244141 8.91091V16.9999C0.000244141 17.5524 0.447744 17.9999 1.00024 17.9999H7.00024V12.2499C7.00024 12.1119 7.11174 11.9999 7.25024 11.9999H10.7502C10.8882 11.9999 11.0002 12.1119 11.0002 12.2499V17.9999H17.0002C17.5522 17.9999 18.0002 17.5524 18.0002 16.9999V8.90591C18.0002 8.35591 17.7797 7.82891 17.3892 7.44191" fill="black" fillOpacity="0.73"/>
                                </svg>
                            </button>
                            
                            {/* 右寄せ: カメラ・音声・マップボタンコンテナ */}
                            <div className="flex items-center bg-gray-100 rounded-full px-1">
                                {/* カメラボタン */}
                                <button
                                    onClick={() => setShowCameraMenu(!showCameraMenu)}
                                    className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-gray-700 hover:bg-gray-50 transition-all mx-0.5"
                                >
                                    <svg width="18" height="16" viewBox="0 0 18 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path fillRule="evenodd" clipRule="evenodd" d="M15.5 6C14.948 6 14.5 5.5525 14.5 4.999C14.5 4.4475 14.948 4 15.5 4C16.052 4 16.5 4.4475 16.5 4.999C16.5 5.5525 16.052 6 15.5 6M9 13.5C6.515 13.5 4.5 11.483 4.5 9C4.5 6.5165 6.515 4.5 9 4.5C11.483 4.5 13.5 6.5165 13.5 9C13.5 11.483 11.483 13.5 9 13.5M16 2H13.5L11.793 0.293C11.6055 0.1055 11.351 0 11.0855 0H6.9145C6.649 0 6.3945 0.1055 6.207 0.293L4.5 2H2C0.9 2 0 2.9 0 4V14C0 15.1 0.9 16 2 16H16C17.1 16 18 15.1 18 14V4C18 2.9 17.1 2 16 2M9 6.30005C7.511 6.30005 6.3 7.51105 6.3 9.00005C6.3 10.4886 7.511 11.7001 9 11.7001C10.489 11.7001 11.7 10.4886 11.7 9.00005C11.7 7.51105 10.489 6.30005 9 6.30005" fill="black" fillOpacity="0.73"/>
                                    </svg>
                                </button>
                                
                                {/* 音声ボタン */}
                                <button
                                    onClick={() => setShowVoiceMenu(!showVoiceMenu)}
                                    className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-gray-700 hover:bg-gray-50 transition-all mx-0.5"
                                >
                                    <svg width="12" height="20" viewBox="0 0 12 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M1.5 9.5V10.5C1.5 12.9815 3.519 15 6 15C8.481 15 10.5 12.9815 10.5 10.5V9.5H12V10.5C12 13.4675 9.83297 15.9312 7 16.4092V18H8.75C9.1645 18 9.5 18.3355 9.5 18.75C9.5 19.1645 9.1645 19.5 8.75 19.5H3.25C2.8355 19.5 2.5 19.1645 2.5 18.75C2.5 18.3355 2.8355 18 3.25 18H5V16.4092C2.16703 15.9312 0 13.4675 0 10.5V9.5H1.5ZM6 0.5C7.6565 0.5 9 1.8435 9 3.5V10.5C9 12.1565 7.6565 13.5 6 13.5C4.3435 13.5 3 12.1565 3 10.5V3.5C3 1.8435 4.3435 0.5 6 0.5Z" fill="black" fillOpacity="0.73"/>
                                    </svg>
                                </button>
                                
                                {/* お気に入りリストボタン */}
                                <button
                                    onClick={() => {
                                        try {
                                            console.log('お気に入りボタンクリック、現在のビュー:', currentView);
                                            console.log('showFavorites:', showFavorites);
                                            console.log('お気に入りレポート数:', favoriteReports.length);

                                            // レポート詳細が開いている場合やお気に入り集約画面の場合はマップに戻る
                                            if (showFavorites || currentView === 'favorites') {
                                                setShowFavorites(false);
                                                setCurrentView('map');
                                            } else {
                                                // マップからの場合はお気に入りリストを表示
                                                setCurrentView('favorites');
                                            }
                                        } catch (error) {
                                            console.error('お気に入りページ表示エラー:', error);
                                        }
                                    }}
                                    className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-gray-700 hover:bg-gray-50 transition-all mx-0.5 relative"
                                    title="お気に入りリスト"
                                >
                                    <svg width="16" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                                    </svg>
                                    {favoriteReports.length > 0 && (
                                        <div className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-normal rounded-full w-5 h-5 flex items-center justify-center">
                                            {favoriteReports.length}
                                        </div>
                                    )}
                                </button>
                            </div>
                        </div>
                        
                        {/* カメラメニュー */}
                        {showCameraMenu && (
                            <div className="absolute bottom-20 right-4 bg-white rounded-lg shadow-xl border p-4 w-48">
                                <div className="text-sm font-medium text-gray-900 mb-3">カメラ機能</div>
                                <div className="space-y-2">
                                    <button className="w-full text-left px-3 py-2 text-sm text-gray-600 hover:bg-gray-50 rounded">
                                        🔍 画像検索
                                    </button>
                                </div>
                                <button
                                    onClick={() => setShowCameraMenu(false)}
                                    className="absolute top-2 right-2 w-6 h-6 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center text-xs"
                                >
                                    ×
                                </button>
                            </div>
                        )}
                        
                        {/* 音声メニュー */}
                        {showVoiceMenu && (
                            <div className="absolute bottom-20 right-4 bg-white rounded-lg shadow-xl border p-4 w-48">
                                <div className="text-sm font-medium text-gray-900 mb-3">音声機能</div>
                                <div className="space-y-2">
                                    <button className="w-full text-left px-3 py-2 text-sm text-gray-600 hover:bg-gray-50 rounded">
                                        🗣️ 音声検索
                                    </button>
                                </div>
                                <button
                                    onClick={() => setShowVoiceMenu(false)}
                                    className="absolute top-2 right-2 w-6 h-6 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center text-xs"
                                >
                                    ×
                                </button>
                            </div>
                        )}
                        
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>